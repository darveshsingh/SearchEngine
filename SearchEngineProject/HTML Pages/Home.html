<!doctype html>
<!--[if lt IE 7 ]> <html class="ie ie6" xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#" lang="en-us"> <![endif]-->
<!--[if IE 7 ]> <html class="ie ie7" xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#" lang="en-us"> <![endif]-->
<!--[if IE 8 ]> <html class="ie ie8" xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#" lang="en-us"> <![endif]-->
<!--[if IE 9 ]> <html class="ie ie9" xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#" lang="en-us"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#" lang="en-us" class="no-js">
 <!--<![endif]-->
 <!--[if gt IE 8]><!-->
 <!--<![endif]-->
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
  <title>Home</title> 
  <meta name="description" content=""> 
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <meta http-equiv="x-ua-compatible" content="IE=Edge"> 
  <meta property="og:type" content="website"> 
  <meta property="fb:app_id" content="1548265938801936"> 
  <style>
            body {
                padding-bottom: 20px;
            }
        </style> 
  <link rel="stylesheet" href="/campusvibe/css/bootstrap.min.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/bootstrap-theme.min.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/fontello-embedded.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/perfect-scrollbar.min.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/sweetalert.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/photoswipe.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/photoswipe-default-skin.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/feeds.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/main.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/cl-landingpage.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/bounceAnimations.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/menuform.css?v=10"> 
  <link rel="stylesheet" href="/campusvibe/css/accessibility.css?v=10"> 
  <link id="custom-stylesheet" rel="stylesheet" href="/campusvibe/css/colorthemes/dark-orangeblue.css?v=10"> 
  <link rel="shortcut icon" href="/campusvibe/img/favicons/dark-orangeblue/favicon.ico?v=699OKbBNab"> 
  <meta name="msapplication-TileColor" content="#2b5797"> 
  <meta name="msapplication-TileImage" content="/campusvibe/img/favicons/dark-orangeblue/mstile-144x144.png?v=699OKbBNab"> 
  <meta name="theme-color" content="#ffffff"> 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script> 
  <script>window.jQuery || document.write('<script src="../js/vendor/jquery-3.1.0.min.js"><\/script>')</script> 
  <script src="/campusvibe/js/vendor/jquery-ui.min.js"></script> 
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700" rel="stylesheet" type="text/css"> 
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"> 
  <script src="/campusvibe/js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script> 
  <script src="//use.typekit.net/okr6clm.js"></script> 
  <script>try{Typekit.load({ async: true });}catch(e){}</script> 
  <link rel="stylesheet" href="//cdn.jsdelivr.net/emojione/2.2.5/assets/css/emojione.min.css"> 
  <script type="text/javascript">

                            var ROOT = "campusvibe";
            
                            var DOMAIN = "https://www.campusvibe.ca";
            
                            var INSTITUTION_NAME = "University of Windsor";
            
                            var CAMPUS_ID = "b3dec320-64b6-413d-bb5e-dcd3afa78737";
            
            
            
            
                            var TEMPLATE = "campus";
            
                            var SLUG = "campus";
            
                            var INSTITUTION_AUTH_TYPE = "authentication_single_signon_cas";
            
                            var SESSION_TIME_OUT_SECONDS = "1800";
            
                            var INSTITUTION_SYS_MODE = "open";
            
                            var INSTITUTION_PRODUCT_NAME = "UWSA Hub";
            
                            var EVENT_POLICY = "moderated";
            
                            var GROUP_POLICY = "moderated";
            
                            var INSTITUTION_POLLS_ENABLED = "true";
            
                            var HTTP_HOST = "www.campusvibe.ca";
            
                            var CV_TOKEN = "10205122465dd88c110a30e8.24221879";
            
                            var USER_TOKEN = "9a3111648e5176ebc2ac4a1d15c5e8dd95261e8b";
            
                            var USER_ID = "";
            
            
                            var COLOR_SCHEME = "dark-orangeblue";
            
                            var LOGGED_IN = false; /* Convenience variable */
            
                            var BANNED_FROM_FEEDS = true; /* Convenience variable */
            
            var CV_USER_ROLE = "user"; /* Convenience variable */

            var INSTITUTION_COORDS = {
              "countryCode" : "",
              "tz" : "Canada/Eastern",
              "currencyType" : "NorthAmerican"
            };

            // SET CURRENCY DEFAULT
            if(!INSTITUTION_COORDS.currencyType){
                INSTITUTION_COORDS.currencyType = "NorthAmerican";
            }

            var SYS_CACHE_V = '10';

                            var FACEBOOK_APP_ID = '1548265938801936';
            
        </script> 
 </head> 
 <body id="page-campuslanding" class="int-page">
  <div id="userLogin-modal-overlay" class="open-mode-vis"></div> 
  <div id="userLogin-modal-wrapper" class="open-mode-vis"> 
   <div id="login-institution-logo-wrapper">
    <div id="login-institution-logo-container">
     <!-- logo -->
    </div>
   </div> 
   <div id="userLogin-modal-container" class="clearfix"> 
    <div class="modal-contents clearfix"> 
     <div id="login-form"> 
      <h3>Login</h3> 
      <p class="login-info">Please login using your UWinID &amp; password</p> 
      <button onclick="location.href='https://www.campusvibe.ca/Skeddy/rest/gem/v1/apitoken/institution/b3dec320-64b6-413d-bb5e-dcd3afa78737'" class="press-button focus medium submit-login" style="margin-top:20px;"><i class="icon-lock" aria-hidden="true"></i> Log in</button> 
     </div> 
     <div id="userLoginMessage"></div> 
     <div id="userLogin-back" class="login-footer">
      Powered by CampusVibe™
     </div> 
     <div id="userLogin-close" class="user-login-back-to-page">
      <button type="button" class="btn-link"><i class="icon-right-open hard-flip" aria-hidden="true"></i> Back to page</button>
     </div> 
    </div> 
   </div> 
  </div> 
  <script type="text/javascript">

            var winW = $(window).width();
            var winH = $(window).height();

            var $onboardingFirstName;
            var $onboardingLastName;
            var $onboardingEmail;
            var $onboardingPassword, $onboardingConfirmPassword, $newPassword, $newConfirmPassword;

            var $signUpEmail;
            var $signUpConfirmEmail;
            var signUpEmailsStringTT = 'Your e-mails must match and be valid.';

            var $SN_INPUT, $SN_INPUT_TT, $SN_INPUT_TT_PANEL, SN_L, SN_FORMAT_STRING, SN_REGEX;

            var MAX_ONBOARDING_PANEL;

            var ONBOARD_USER_ID, USER_API_TOKEN;

            var URL_ACTION_PARAM = "";
            var REDIR_GROUP_ACTION = "";
            var REDIR_PAGE_ACTION = "";
            var ONBOARDING_ACTION = "";
            var PWRESET_ACTION = "";
            var API_TOKEN_GET = '';
            var IS_NEW_PW;

            var AUTH_METHOD = "user-login-external";
            var AUTH_METHOD_UI = AUTH_METHOD;

            var TRIGGER_LOGIN = (INSTITUTION_SYS_MODE != "open" || (INSTITUTION_SYS_MODE == "open" && (REDIR_PAGE_ACTION || REDIR_GROUP_ACTION || ONBOARDING_ACTION || PWRESET_ACTION)) || (AUTH_METHOD == "user-login-external" && API_TOKEN_GET)) ? true : false;

            // Open overlay
            if(TRIGGER_LOGIN){
              $("body").css("overflow", "hidden");
              $("#userLogin-modal-overlay").addClass("userLogin-show");
            }

            var $MODAL_CONTAINER = $("#userLogin-modal-container");
            var MODAL_CONTAINER_H = $MODAL_CONTAINER.height();

            var institutionInitProductName = (INSTITUTION_PRODUCT_NAME) ? INSTITUTION_PRODUCT_NAME : 'Institution';
            var logoImageAltText = 'The ' + institutionInitProductName + ' logo image';
            var logoImageTitleText = logoImageAltText;
            var logoImageAriaLabelText = logoImageAltText + ' overlayed on a ribbon banner.';

            // Cloning Institution's logo
            var img = $('<img />',{ 'src': "https://www.campusvibe.ca/Skeddy/rest/gem/v1/image/194f8299-e57c-4cd0-afab-7bdee314b4f9?sname=CampusSchema", 'alt': logoImageAltText, 'title': logoImageTitleText}).appendTo($('#login-institution-logo-container'));
            $("#login-institution-logo-container").attr("aria-label", logoImageAriaLabelText);

            var RIBBON_H = (winH < 750) ? 190 : 240;

            // Vertically centering the login form
            var $RIBBON = $("#login-institution-logo-wrapper");
            var winH_offset = winH-RIBBON_H;

            $("#login-institution-logo-container").css("height", RIBBON_H + "px");

            $MODAL_CONTAINER.css("top", (RIBBON_H + winH_offset/2 - MODAL_CONTAINER_H/2 - winH_offset*0.05) + "px" )

            // Open container
            if(TRIGGER_LOGIN){
              $MODAL_CONTAINER.addClass("open");

              if(REDIR_PAGE_ACTION || REDIR_GROUP_ACTION){

                setTimeout(function(){

                  //if($('input[name="login-email"]').val().length){
                    //$("#login-remember-me-container").css("display", "block").animate({"top" : "0px", "opacity" : "1"}, "slow");
                  //}

                }, 400);

              }

            }

            $('#login-password').on("input", function() {
              /*
                var dInput = this.value;
                if(dInput.length >= 2){
                  $("#login-remember-me-container").css("display", "block").animate({"top" : "0px", "opacity" : "1"}, "slow");
                }else{
                  $("#login-remember-me-container").css("display", "none");
                }
              */
            });

            $("#userLogin-modal-container #userLogin-back button, #userLogin-modal-container #userLogin-close button").on('click', function(){
              $("#userLogin-modal-overlay").removeClass("userLogin-show");
              $("#userLogin-modal-container").removeClass("open");
              $("#login-institution-logo-container").animate({"top" : "-250px"}, "fast", "easeOutExpo", function(){
                /*if(TRIGGER_LOGIN){
                  $("#userLogin-modal-wrapper").remove();
                  $("#userLogin-modal-overlay").remove();
                }else{*/
                  $('body').css("overflow", "visible");
                  $("#userLogin-modal-wrapper").removeClass("userLogin-show").addClass("open-mode-vis");
                  $("#userLogin-modal-overlay").removeClass("open").addClass("open-mode-vis");                  
                //}
              });
              if($('#onboarding-wrapper').length){
                $('#onboarding-wrapper').remove();
              }
              // HOMEPAGE
              if(SLUG == "campus"){
                var $carrProgressBar = $("#carr-progressbar");
                var remainingTime = ($carrProgressBar.attr("data-remainingMs")) ? Number($carrProgressBar.attr("data-remainingMs")) : CARR_change_slide_speed;
                $carrProgressBar.animate({"width" : "100%"}, remainingTime, function(e){
                    CARR__getNewCarSlide();
                });
              }
            });

            $("#login-remember-me-container").click(function(){
              /*
              if($(this).find("i").hasClass("icon-check-empty")){
                $(this).addClass("login-remember-me-focus").find("i").removeClass("icon-check-empty").addClass("icon-check");
              }else{
                $(this).removeClass("login-remember-me-focus").find("i").removeClass("icon-check").addClass("icon-check-empty");
              }
              */
            });

            $("form#login-form").submit(function(event){

              event.preventDefault();

              if (typeof(request) != "undefined" && request) {
                  request.abort();
              }

              //console.log("SUBMITTING FORM...");

              var $form = $(this);
              var $inputs = $form.find("input");
              var serializedData = $form.serialize();
              var $buttonSubmit = $("form#login-form button.submit-login");

              $inputs.prop("disabled", true);

              if(AUTH_METHOD == "user-login"){

                var form_data = {
                  data: serializedData,
                  USER_CV_TOKEN: CV_TOKEN,
                  URL_ACTION : URL_ACTION_PARAM,
                  domain: DOMAIN,
                  is_ajax: 1,
                  usernameFormat : "Username",
                  INSTITUTION_ID : "b3dec320-64b6-413d-bb5e-dcd3afa78737"
                };

              }else if(AUTH_METHOD == "user-login-external"){

                var API_TOKEN_PARAM = '';
                var API_USER_ID = '';

                var form_data = {
                  USER_CV_TOKEN: CV_TOKEN,
                  URL_ACTION : URL_ACTION_PARAM,
                  domain: DOMAIN,
                  USER_API_TOKEN : API_TOKEN_PARAM,
                  USER_LOGIN_ID : API_USER_ID,
                  is_ajax: 1,
                  usernameFormat : "Username",
                  INSTITUTION_ID : "b3dec320-64b6-413d-bb5e-dcd3afa78737"
                };

              }else if(AUTH_METHOD == "user-login-basic"){

                var API_TOKEN_PARAM = '';
                var API_USER_ID = '';

                if(API_TOKEN_PARAM && API_USER_ID && !IS_NEW_PW){

                  var form_data = {
                    USER_CV_TOKEN: CV_TOKEN,
                    URL_ACTION : URL_ACTION_PARAM,
                    domain: DOMAIN,
                    USER_API_TOKEN : API_TOKEN_PARAM,
                    USER_LOGIN_ID : API_USER_ID,
                    is_ajax: 1,
                    usernameFormat : "Username",
                    INSTITUTION_ID : "b3dec320-64b6-413d-bb5e-dcd3afa78737"
                  };

                }else{

                  AUTH_METHOD_UI = "user-login";

                  var form_data = {
                    data: serializedData,
                    USER_CV_TOKEN: CV_TOKEN,
                    URL_ACTION : URL_ACTION_PARAM,
                    domain: DOMAIN,
                    is_ajax: 1,
                    usernameFormat : "Username",
                    INSTITUTION_ID : "b3dec320-64b6-413d-bb5e-dcd3afa78737"
                  };

                }

              }

              $buttonSubmit.prop("disabled", true).attr('tabindex', '-1').html('<i class="fa fa-spinner fa-spin"></i> Log in');
              $('button[name="signUp"]').prop("disabled", true).attr('tabindex', '-1');

              var USER_OBJECT;

              // ********** LOGIN **********

              cvConsoleLog("FORM_DATA", "A1");
              cvConsoleLog(form_data, "A2");

              $.ajax({
                  url: '/' + ROOT + '/inc/templates/ajax/'+ AUTH_METHOD_UI +'.php',
                  type: "POST",
                  data: form_data,
                  dataType: "json",
                  success: function(data){

                    cvConsoleLog("RESPONSE", "B1");
                    cvConsoleLog(data, "B2");

                    USER_API_TOKEN = (data.apiToken && data.apiToken != "null") ? data.apiToken : false;
                    ONBOARD_USER_ID = (data.userId && data.userId != "null") ? data.userId : false;

                    //console.log("form_data");
                    //console.log(form_data);

                    if(data.response == "allow"){

                      if(data.url_action == "pwreset"){ // IF THE USER WANTS TO RESET HIS PASSWORD

                        // GET NEW PASSWORD UI
                        $.ajax({
                          type: "POST",
                          url: '/' + ROOT + '/inc/templates/handlebars/new-password.php',
                          dataType : 'text',
                          success: function(newPasswordUI){
                            if(newPasswordUI){

                              $("div#userLogin-modal-wrapper").append(newPasswordUI);

                              $('input[name="forgotPasswordEmail"]').focus();

                              var $userLoginContainer = $("div#userLogin-modal-container");

                              $userLoginContainer.animate({"left" : "-" + ($userLoginContainer.width()/2)+"px"}, "fast", "easeOutExpo", function(){

                                $('form#login-form button.submit-login').find("i").removeClass().addClass("icon-lock");
                                $('input[name="newPassword"]').focus();

                                $newPassword = $('form#newPW-form input[name="newPassword"]');
                                $newConfirmPassword = $('form#newPW-form input[name="newConfirmPassword"]');

                              });

                              $("div#new-password-wrapper").css({"top" : parseInt($userLoginContainer.css("top"), 10) + 40 + "px"}).animate({"left" : "50%"}, "fast", "easeOutExpo");

                            }
                          },
                          error : function(xhr){
                            swal("Error", "Could not load the 'Create new password' form. Please try again.", "error");
                          }

                        });

                      }else if(data.pw_reset_req == "true"){ // IF THE USER NEEDS TO RESET HIS PASSWORD

                        console.log("PASSWORD RESET REQUIRED");

                        console.log("User token JSON");
                        console.log(data.user_token_json);

                        var userResetEmail = returnPlainHTML(parse_OBJ(data.user_token_json.i, "primaryEmailAddress"));
                        var userResetEmailStr = (userResetEmail && userResetEmail != null) ? userResetEmail : '<youremail@university.ca>';

                        var resetPW_ui_data = {
                          USER_RESET_EMAIL : userResetEmailStr,
                          USER_EMAIL : userResetEmail
                        }

                        // GET RESET PASSWORD UI
                        $.ajax({
                          type: "POST",
                          url: '/' + ROOT + '/inc/templates/handlebars/reset-password.php',
                          data : resetPW_ui_data,
                          dataType : 'text',
                          success: function(resetPasswordUI){
                            if(resetPasswordUI){

                              $("div#userLogin-modal-wrapper").append(resetPasswordUI);

                              var $userLoginContainer = $("div#userLogin-modal-container");

                              $userLoginContainer.animate({"left" : "-" + ($userLoginContainer.width()/2)+"px"}, "fast", "easeOutExpo", function(){
                                $('form#login-form button.submit-login').find("i").removeClass().addClass("icon-lock");
                              });

                              $("div#forgot-password-wrapper").css({"top" : parseInt($userLoginContainer.css("top"), 10) + 40 + "px"}).animate({"left" : "50%"}, "fast", "easeOutExpo");

                            }
                          },
                          error : function(xhr){
                            swal("Error", "Could not load the 'Reset password' form. Please try again.", "error");
                          }

                        });

                      }else{

                       if(data.onboarding == "true"){ // IF USER HAS PREVIOUSLY ONBOARDED...

                          if(TRIGGER_LOGIN){
                            if(REDIR_GROUP_ACTION || REDIR_PAGE_ACTION){
                              if(REDIR_PAGE_ACTION){
                                console.log("data");
                                console.log(data);
                                window.location.href = REDIR_PAGE_ACTION;
                              }else if(REDIR_GROUP_ACTION){
                                window.location.href = '/' + ROOT + '/group/' + CAMPUS_ID + '/' + REDIR_GROUP_ACTION;
                              }
                            }else{
                              window.location.href = '/' + ROOT + '/campus/' + CAMPUS_ID;
                            }
                          }else{
                            window.location.reload();
                          }

                        }else if(data.onboarding == "false"){ // IF USER ONBOARDS...

                          console.log("ONBOARDING");

                          USER_OBJECT = data.userObject;

                          var onboarding_ui_data = {
                            institutionName : "University of Windsor",
                            institutionProductName : "UWSA Hub"
                          }

                          $.when(
                            $.ajax({
                              type : 'GET',
                              url : DOMAIN + '/Skeddy/rest/gem/v1/institution/'+CAMPUS_ID+'?sname=CampusSchema&apitoken='+USER_TOKEN,
                              dataType : 'json'
                            }),
                            $.ajax({
                              type : 'GET',
                              url : DOMAIN + '/Skeddy/rest/gem/v1/institution/' + CAMPUS_ID + '/label/programtype?sname=CampusSchema&apitoken='+USER_API_TOKEN,
                              dataType : 'json'
                            }),
                            $.ajax({
                              type : 'GET',
                              url : DOMAIN + '/Skeddy/rest/gem/v1/institution/' + CAMPUS_ID + '/label/usertype?sname=CampusSchema&apitoken='+USER_API_TOKEN,
                              dataType : 'json'
                            }),
                            $.ajax({
                              type : 'GET',
                              url : DOMAIN + '/Skeddy/rest/gem/v1/campus?institutionid=' + CAMPUS_ID + '&sname=CampusSchema&apitoken=' + USER_API_TOKEN,
                              dataType : 'json'
                            })
                          ).then(function(institutionOBJ, programTypeList, userTypeList, campusList){

                            if(institutionOBJ[0] && programTypeList[0] && userTypeList[0] && campusList[0]){
                      
                              // GET ONBOARDING UI
                              $.ajax({
                                type: "POST",
                                url: '/' + ROOT + '/inc/templates/handlebars/onboarding-ui.php',
                                data : onboarding_ui_data,
                                dataType : 'text',
                                success: function(onboardingUI){
                                  if(onboardingUI){
        
                                    $("div#userLogin-modal-wrapper").append(onboardingUI);

                                    Handlebars.registerHelper('userFirstName', function(){
                                      var userFirstName = parse_OBJ(USER_OBJECT.i, "firstName");
                                      if(userFirstName) return new Handlebars.SafeString(Handlebars.escapeExpression(userFirstName));
                                    });

                                    Handlebars.registerHelper('userLastName', function(){
                                      var userLastName = parse_OBJ(USER_OBJECT.i, "lastName");
                                      if(userLastName) return new Handlebars.SafeString(Handlebars.escapeExpression(userLastName));
                                    });

                                    Handlebars.registerHelper('userEmailAddress', function(){
                                      var userEmailAddress = parse_OBJ(USER_OBJECT.i, "EmailAddress");
                                      if(userEmailAddress) return new Handlebars.SafeString(Handlebars.escapeExpression(userEmailAddress));
                                    });

                                    Handlebars.registerHelper('ROOT', function(){
                                      return new Handlebars.SafeString(ROOT);
                                    });

                                    Handlebars.registerHelper('IF_AUTH_BASIC', function(options){
                                      if(AUTH_METHOD == "user-login-basic"){
                                        return options.fn(this);
                                      }else{
                                        return options.inverse(this);
                                      }
                                    });

                                    Handlebars.registerHelper('IF_SYS_OPEN', function(options){
                                      if(INSTITUTION_SYS_MODE == "open"){
                                        return options.fn(this);
                                      }else{
                                        return options.inverse(this);
                                      }
                                    });

                                    Handlebars.registerHelper('IF_MULTICAMPUS', function(options){
                                      if(campusList[0].listT.length > 1){
                                        return options.fn(this);
                                      }
                                    });

                                    Handlebars.registerHelper('IF_SN_MANDATORY', function(options){
                                      if(parse_OBJ(institutionOBJ[0].i, "StudentNumberMandatory") == "true"){
                                        return options.fn(this);
                                      }
                                    });

                                    Handlebars.registerHelper('userStudentNumber', function(){
                                      var userSN = parse_OBJ(USER_OBJECT.i, "StudentNumber");
                                      if(userSN) return new Handlebars.SafeString(Handlebars.escapeExpression(userSN));
                                    });

                                    Handlebars.registerHelper('snMaxLength', function(){
                                      return new Handlebars.SafeString(parse_OBJ(institutionOBJ[0].i, "StudentNumberLength"));
                                    });

                                    Handlebars.registerHelper('snFormat', function(){
                                      return new Handlebars.SafeString(parse_OBJ(institutionOBJ[0].i, "StudentNumberFormat"));
                                    });

                                    /*
                                    Handlebars.registerHelper('yearOfStudy', function() {
                                      var YOS = parse_OBJ(USER_OBJECT.i, "YearOfStudy");
                                      var yearOfStudyOptionMenu = "";
                                      for(var i = 1; i <= 10; i++){
                                        var sel = (YOS == i) ? ' selected="selected"' : '';
                                        yearOfStudyOptionMenu += '<option data-filterName="'+ i +'" data-filterLabel="'+ i +'" class="option-filter-type"' + sel + '>'+ i +'</option>';
                                      }
                                      return new Handlebars.SafeString(yearOfStudyOptionMenu); 
                                    });

                                    Handlebars.registerHelper('areYouGraduatingThisYearOptions', function() {
                                      var optionsHTML = '';
                                      var optionVal = (parse_OBJ(USER_OBJECT.i, "GraduatingThisYear") == "true") ? "yes" : "no";
                                      var OPTIONS = ["yes", "no"];
                                      $.each(OPTIONS, function(index, option){
                                        if(option != optionVal){
                                          optionsHTML += '<div data-policy="'+option+'">' + option.toUpperCase() + '</div>';
                                        }else{
                                          optionsHTML += '<div data-checked="checked" class="secondaryColorBGForced" data-policy="'+option+'"><i class="fa fa-check"></i> ' + option.toUpperCase() + '</div>';
                                        }
                                      });
                                      return new Handlebars.SafeString(optionsHTML);
                                    });
                                    */

                                    var template_userInfo = Handlebars.compile($("#onboarding-userNameAndEmail-template").html());
                                    $('#onboarding-userNameAndEmail-template').after(template_userInfo(USER_OBJECT));

                                    var template_footer = Handlebars.compile($("#onboarding-footer-template").html());
                                    $('#onboarding-footer-template').after(template_footer(USER_OBJECT));

                                    var template = Handlebars.compile($("#onboarding-programTypes-template").html());
                                    $('#onboarding-programTypes-template').after(template(programTypeList[0].label));

                                    var template = Handlebars.compile($("#onboarding-userTypes-template").html());
                                    $('#onboarding-userTypes-template').after(template(userTypeList[0].label));

                                    //var template = Handlebars.compile($("#onboarding-yearOfStudy-template").html());
                                    //$('#onboarding-yearOfStudy-template').after(template);

                                    //var template = Handlebars.compile($("#onboarding-graduatingThisYear-template").html());
                                    //$('#onboarding-graduatingThisYear-template').after(template);

                                    var template = Handlebars.compile($("#onboarding-studentNumber-template").html());
                                    $('#onboarding-panel-6').before(template);

                                    var template = Handlebars.compile($("#onboarding-campus-template").html());
                                    $('#onboarding-panel-3').after(template(campusList[0].listT));

                                    var template_pw = Handlebars.compile($("#onboarding-password-template").html());
                                    $('#onboarding-panel-4').after(template_pw);

                                    if(!programTypeList[0].label.length) $('div.onboarding-panel[data-section="programType"]').attr("data-valid", "true");
                                    if(!userTypeList[0].label.length) $('div.onboarding-panel[data-section="userType"]').attr("data-valid", "true");

                                    var $onboardingWrapper = $("div#onboarding-wrapper");
                                    var $userLoginContainer = $("div#userLogin-modal-container");

                                    $onboardingFirstName = $('input[name="onboardingFirstName"]');
                                    $onboardingLastName = $('input[name="onboardingLastName"]');
                                    $onboardingEmail = $('input[name="onboardingEmail"]');

                                    $onboardingPassword = $('input[name="onboardingPassword"]');
                                    $onboardingConfirmPassword = $('input[name="onboardingConfirmPassword"]');

                                    $userLoginContainer.animate({"left" : "-" + ($userLoginContainer.width()/2)+"px"}, "fast", "easeOutExpo");
                                    $onboardingWrapper.css({"top" : parseInt($userLoginContainer.css("top"), 10) + "px"}).animate({"left" : "50%"}, "fast", "easeOutExpo");

                                    $("input[name='onboardingFirstName']").focus();

                                    // VALIDATE PRE-FILLED FIELDS

                                    // First name / Last name
                                    if(checkFirstAndLastName($onboardingLastName.val()) && checkFirstAndLastName($onboardingFirstName.val())){
                                      $("div.onboarding-panel[data-section='firstLastName']").attr("data-valid", "true").focus();
                                      $("button[data-nav='next']").removeClass("grayed-out fired").prop("disabled", false);
                                    }

                                    // Email
                                    var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                    if($onboardingEmail.val() && regex.test($onboardingEmail.val())){
                                      $("div.onboarding-panel[data-section='email']").attr("data-valid", "true");
                                    }

                                    // Program type
                                    var userProgramType = parse_OBJ(USER_OBJECT.i, "ProgramTypeId");
                                    if(typeof(userProgramType) != "undefined" && userProgramType){
                                      var programTypeOption = $('select[name="onboardingUserProgramType"]').find('option[data-filterlabel="'+ userProgramType +'"]');
                                      if(programTypeOption && programTypeOption.length){
                                        programTypeOption.prop("selected", true);
                                        $("div.onboarding-panel[data-section='programType']").attr("data-valid", "true");
                                        var $programTypeSelect = $('form#onboarding-form select[name="onboardingUserProgramType"]');
                                        $programTypeSelect.find("option:not(:first-child)").prop("disabled", false).css("display", "block");
                                        $programTypeSelect.find("option:selected").prop("disabled", true).css("display", "none");
                                      }
                                    }

                                    // Campus
                                    if(campusList[0].listT.length > 1){
                                      var userCampusId = parse_OBJ(USER_OBJECT.i, "CampusId");
                                      if(typeof(userCampusId) != "undefined" && userCampusId){
                                        var campusOption = $('select[name="onboardingUserCampusId"]').find('option[data-filterlabel="'+ userCampusId +'"]');
                                        if(campusOption && campusOption.length){
                                          campusOption.prop("selected", true);
                                          $("div.onboarding-panel[data-section='campusId']").attr("data-valid", "true");
                                          var $campusSelect = $('form#onboarding-form select[name="onboardingUserCampusId"]');
                                          $campusSelect.find("option:not(:first-child)").prop("disabled", false).css("display", "block");
                                          $campusSelect.find("option:selected").prop("disabled", true).css("display", "none");
                                        }
                                      }
                                    }

                                    // User type
                                    var userUserType = parse_OBJ(USER_OBJECT.i, "UserTypeId");
                                    if(typeof(userUserType) != "undefined" && userUserType){
                                      var userTypeOption = $('select[name="onboardingUserType"]').find('option[data-filterlabel="'+ userUserType +'"]');
                                      if(userTypeOption && userTypeOption.length){
                                        userTypeOption.prop("selected", true);
                                        $("div.onboarding-panel[data-section='userType']").attr("data-valid", "true");
                                        var $userTypeSelect = $('form#onboarding-form select[name="onboardingUserType"]');
                                        $userTypeSelect.find("option:not(:first-child)").prop("disabled", false).css("display", "block");
                                        $userTypeSelect.find("option:selected").prop("disabled", true).css("display", "none");
                                      }
                                    }

                                    // Year of study
                                    /*
                                    var userYearOfStudy = parse_OBJ(USER_OBJECT.i, "YearOfStudy");
                                    if(typeof(userYearOfStudy) != "undefined" && userYearOfStudy){
                                      var yearOfStudyOption = $('select[name="onboardingYearOfStudy"]').find('option[data-filterlabel="'+ userYearOfStudy +'"]');
                                      if(yearOfStudyOption && yearOfStudyOption.length){
                                        yearOfStudyOption.prop("selected", true);
                                        $("div.onboarding-panel[data-section='yearOfStudy']").attr("data-valid", "true");
                                        var $yearOfStudySelect = $('form#onboarding-form select[name="onboardingYearOfStudy"]');
                                        $yearOfStudySelect.find("option:not(:first-child)").prop("disabled", false).css("display", "block");
                                        $yearOfStudySelect.find("option:selected").prop("disabled", true).css("display", "none");
                                      }
                                    }
                                    */

                                    MAX_ONBOARDING_PANEL = $("div.onboarding-panel").length;

                                    // STUDENT NUMBER

                                    $SN_INPUT = $('input[name="onboardingStudentNumber"]');

                                    if($SN_INPUT.length){
                                      $SN_INPUT_TT = $('p.fieldset[data-fieldName="studentNumber"]');
                                      $SN_INPUT_TT_PANEL = $SN_INPUT_TT.parent('div.onboarding-panel');
                                      SN_L = $SN_INPUT.attr("data-maxLength");
                                      SN_FORMAT_STRING = ($SN_INPUT.attr("data-format") == "alphanumeric") ? 'letters and numbers' : ($SN_INPUT.attr("data-format") == "numeric") ? 'numbers' : ($SN_INPUT.attr("data-format") == "alpha") ? 'letters' : 'letters and numbers';
                                      SN_REGEX = ($SN_INPUT.attr("data-format") == "alphanumeric") ? /^[a-z0-9_-]*$/i : ($SN_INPUT.attr("data-format") == "numeric") ? /^[0-9_-]*$/i : ($SN_INPUT.attr("data-format") == "alpha") ? /^[a-z_-]*$/i : /^[a-z0-9_-]*$/i;

                                      var sn_val = $SN_INPUT.val();

                                      if($.trim(sn_val).length && SN_REGEX.test(sn_val) && ((sn_val.length == SN_L && SN_L != "0") || (SN_L == "0" && sn_val.length <= 99))){
                                        $SN_INPUT.parents('div.onboarding-panel').attr("data-valid", "true");
                                      }

                                    }

                                    $('[data-toggle="tooltip"]').tooltip({'placement': 'top', 'trigger' : 'manual'});

                                    // LOGIN FORM

                                    $("form#login-form button.submit-login")
                                    .html('<i class="icon-lock"></i> Log in');

                                    // ACCESSIBILITY

                                    var $ONBOARDING_FORM_CONTAINER = $("#onboarding-wrapper");

                                    $ONBOARDING_FORM_CONTAINER
                                    .find('.onboarding-panel')
                                    .first()
                                    .find('input[type="text"], select')
                                    .attr('tabindex', '0');

                                    $ONBOARDING_FORM_CONTAINER.on("keydown", function(e){
                                        cv__document__keydown(e, $DOCUMENT, $ONBOARDING_FORM_CONTAINER, 'onboarding-modal-container',
                                        function(){
                                            // Escape key
      
                                        },
                                        function(){
                                            // Enter key
                                            if($('.onboarding-back-to-login-btn').is(document.activeElement)){
                                                //returnToLoginPanel();
                                            }
                                        });
                                    });

                                  }
                                }
                              });

                            }else{
                              console.log("Error : No program list or user list could be found.");
                            } // programTypeList && userTypeList

                          });

                        }

                      }

                    }else{

                      if(AUTH_METHOD == "user-login" || AUTH_METHOD == "user-login-basic"){

                        //$("#login-remember-me-container").css("display", "none");
                        $inputs.val("");
                        $buttonSubmit.prop("disabled", false).html('<i class="icon-lock"></i> Log in').attr('tabindex', '0');
                        $('button[name="signUp"]').prop("disabled", false);
                        $("div#userLoginMessage").css("display", "block").empty().html(data.response);
                        $('div#login-form-container').effect("shake");
                        setTimeout( function(){ $("form#login-form").find('input[name="login-email"]').focus(); }, 100);

                      }else if(AUTH_METHOD == "user-login-external"){

                        window.location.href = '/' + ROOT + '/campus/' + CAMPUS_ID + '?ref=user_error_001';

                      }
 
                    }
                    $inputs.prop("disabled", false);

                    return false;
                  },
                  error: function(data){
                    if(AUTH_METHOD == "user-login"){
                      //$("#login-remember-me-container").css("display", "none");
                      $inputs.val("");
                      $buttonSubmit.prop("disabled", false).html('<i class="icon-lock"></i> Log in').attr('tabindex', '0');
                      $('button[name="signUp"]').prop("disabled", true);
                      $("div#userLoginMessage").css("display", "block").empty().html(data.response);
                      $('div#login-form-container').effect("shake");
                      setTimeout( function(){ $("form#login-form").find('input[name="login-email"]').focus(); }, 100);
                      $inputs.prop("disabled", false);
                    }else if(AUTH_METHOD == "user-login-external"){
                      window.location.href = '/' + ROOT + '/campus/' + CAMPUS_ID + '?ref=user_error_001';
                    }
                  }
              });

          });

        // FUNCTION READY

        $(function() {

            $("div#login-form-container input#login-email").focus();

            var PANELS_NAV_CTN = 0;
            var FORM_ANIM_T = 600;
            var FORM_EASE = "easeOutExpo";

            // ARIA support
            var hasNewUserSignUpButtonBeenPressed = false;

            $("#submit-sign-up-button").focusout(function(){
                if (!hasNewUserSignUpButtonBeenPressed){
                    setTimeout(function (){
                        $("#sign-up-email").focus();
                    }, 0);
                }
            });

            // RETURN TO LOGIN SCREEN
            $("div#userLogin-modal-wrapper").on('click', 'button.onboarding-back-to-login-btn', function(){

                var $userLoginContainer = $("div#userLogin-modal-container");
                var $onboardingWrapper = $("div#onboarding-wrapper");
                var $LOGIN_FORM = $("form#login-form");

                $userLoginContainer.animate({"left" : "50%"}, "fast", "easeOutExpo", function(){
                    $LOGIN_FORM
                    .find("button.submit-login")
                    .prop('disabled', false)
                    .attr('tabindex', '0');
                    $LOGIN_FORM
                    .find('[tabindex="0"]')
                    .first()
                    .focus();
                });
                $onboardingWrapper.animate({
                    "opacity" : "0"
                }, "fast", function(){
                    $('#onboarding-wrapper').remove();
                    PANELS_NAV_CTN = 0;
                    MAX_ONBOARDING_PANEL = 0;
                });

            });

            // NEXT SLIDE
            $("div#userLogin-modal-wrapper").on({
              click: function (e) {

                e.preventDefault();

                if(PANELS_NAV_CTN <= (MAX_ONBOARDING_PANEL - 2) && !$(this).hasClass("fired") && $("div.active-panel").attr("data-valid") == "true"){

                  $(this)
                  .addClass("fired grayed-out")
                  .prop("disabled", true)
                  .attr('tabindex', '-1');

                  var $activePanel = $("div.onboarding-panel.active-panel");
                  var $nextPanel = $activePanel.next(".onboarding-panel");

                  if(PANELS_NAV_CTN == (MAX_ONBOARDING_PANEL - 2)){

                    $(this).addClass("grayed-out").attr('tabindex', '-1');

                    $("div#onboarding-loading").css("display", "block"); // Loading animation

                    // Delete tooltips
                    $activePanel.find("input").parent("p").tooltip('destroy');

                    // VALIDATION

                    var ONBOARDING_firstName = $('input[name="onboardingFirstName"]').val().trim();
                    var ONBOARDING_lastName = $('input[name="onboardingLastName"]').val().trim();
                    var ONBOARDING_email = $('input[name="onboardingEmail"]').val().trim();
                    var ONBOARDING_programTypeLabel = $('select[name="onboardingUserProgramType"]').find("option:selected").attr("data-filterLabel");
                    var ONBOARDING_userTypeLabel = $('select[name="onboardingUserType"]').find("option:selected").attr("data-filterLabel");
                    //var ONBOARDING_userYearOfStudy = $('select[name="onboardingYearOfStudy"]').find("option:selected").attr("data-filterLabel");

                    //var gradThisYearAttr = $('div#graduatingThisYear div[data-checked="checked"]').attr("data-policy");
                    //var ONBOARDING_GRADTHISYEAR = (gradThisYearAttr == "yes") ? "true" : (gradThisYearAttr == "no") ? "false" : "false";

                    var ONBOARDING_PASSWORD = ($('input[name="onboardingPassword"]').length) ? $('input[name="onboardingPassword"]').val() : false;
                    var ONBOARDING_CONFIRM_PASSWORD = ($('input[name="onboardingConfirmPassword"]').length) ? $('input[name="onboardingConfirmPassword"]').val() : false;

                    if(checkFirstAndLastName(ONBOARDING_firstName) && checkFirstAndLastName(ONBOARDING_lastName) && checkEmail(ONBOARDING_email) && ONBOARDING_programTypeLabel && ONBOARDING_userTypeLabel && checkPasswords(ONBOARDING_PASSWORD, ONBOARDING_CONFIRM_PASSWORD)){

                      $activePanel.removeClass("active-panel");
                      $nextPanel.addClass("active-panel");

                      $('.user-login-back-to-page').hide();

                      $.when($activePanel.add($nextPanel).add("form#onboarding-form > h3:eq(0), form#onboarding-form > p.onboarding-title, form#onboarding-form > p.onboarding-desc, small#userLogin-back, #onboarding-nav-main-buttons").animate({"opacity" : "0"}, FORM_ANIM_T, FORM_EASE)).then(function () {

                        var user_data = {
                          "firstName" : ONBOARDING_firstName,
                          "lastName" : ONBOARDING_lastName,
                          "EmailAddress" : ONBOARDING_email,
                          "ProgramTypeId": ONBOARDING_programTypeLabel,
                          "UserTypeId" : ONBOARDING_userTypeLabel,
                          "userHasLoggedIn" : true
                        };

                        // Campus (if multicampus)
                        var $selectCampus = $('select[name="onboardingUserCampusId"]');
                        if($selectCampus.length){
                          $.extend(user_data, {
                            "CampusId" : $selectCampus.find("option:selected").attr("data-filterLabel")
                          });
                        }

                        // Student number
                        var $studentNumber = $('input[name="onboardingStudentNumber"]');
                        if($studentNumber.length){
                          $.extend(user_data, {
                            "StudentNumber" : $studentNumber.val().trim()
                          });
                        }

                        var onboard_user_data = {
                          userId: ONBOARD_USER_ID,
                          domain: DOMAIN,
                          is_ajax: 1,
                          apiToken: USER_API_TOKEN,
                          INSTITUTION_ID : "b3dec320-64b6-413d-bb5e-dcd3afa78737"
                        };

                        $activePanel.css({"left" : "-=100%"});
                        $nextPanel.css({"left" : "0px"});

                        $.when(
                          $.ajax({
                            type : 'GET',
                            url : DOMAIN + '/Skeddy/rest/gem/v1/user/'+ONBOARD_USER_ID+'?sname=CampusSchema&apitoken='+USER_API_TOKEN,
                            dataType : 'json'
                          })
                        ).then(function(userOBJ){

                          // Updating keys
                          $.each(user_data, function(index, value){
                            update_key(userOBJ.i, index, value);
                          });

                          // Adding password
                          if(ONBOARDING_PASSWORD && ONBOARDING_CONFIRM_PASSWORD) userOBJ.i.push({"k" : "Password", "v" : ONBOARDING_PASSWORD});

                          $.ajax({
                            headers: { 
                                "Accept" : "application/json",
                                "Content-Type": "application/json"
                            },
                            type : 'PUT',
                            url : DOMAIN + '/Skeddy/rest/gem/v1/user/' + ONBOARD_USER_ID + '?sname=CampusSchema&apitoken=' + USER_API_TOKEN,
                            data : JSON.stringify(userOBJ),
                            dataType : 'json',
                            contentType: "application/json",
                            success: function (data, status, jqXHR) {

                              if(data){

                                $.ajax({
                                  url: '/' + ROOT + '/inc/templates/ajax/onboarding.php',
                                  type: "POST",
                                  data: onboard_user_data,
                                  dataType: "json",
                                  success: function(data){

                                    if(data.response == "allow"){

                                      var $onboardedScreen = $("#onboarding-get-started");

                                      $("div#onboarding-loading").css("display", "none");
                                      $("form#onboarding-form > h3:eq(0), form#onboarding-form > p.login-info, small#userLogin-back, form#onboarding-form > p.onboarding-desc").css("display", "none");
                                      $("#onboarding-nav-main-buttons").css("display", "none");
                                      $onboardedScreen.css({"display" : "block", "opacity" : "1"});
                                      $("div#onboarding-panels-wrapper").css("margin-top", "70px"); // CSS tweak
                                      $nextPanel.css({"visibility" : "visible", "display" : "block"}).animate({"opacity" : "1"}, "slow", FORM_EASE);

                                      $onboardedScreen
                                      .find('[name="onboardUser"]')
                                      .attr('tabindex', '0')
                                      .focus();

                                      $("div#userLogin-modal-wrapper").on({
                                        click: function () {

                                         if(REDIR_GROUP_ACTION || REDIR_PAGE_ACTION){
                                            if(REDIR_PAGE_ACTION){
                                              window.location.href = REDIR_PAGE_ACTION;
                                            }else if(REDIR_GROUP_ACTION){
                                              window.location.href = '/' + ROOT + '/group/' + CAMPUS_ID + '/' + REDIR_GROUP_ACTION;
                                            }
                                          }else{
                                            window.location.reload();
                                          }

                                        }
                                      }, 'div#onboarding-get-started button[name="onboardUser"]');

                                    }else{
                                      alert("Sorry, there was an error. Please refresh the page and try again. #001");
                                      $('.user-login-back-to-page').hide();
                                      console.log("ERROR");
                                      console.log(jqXHR);                                      
                                    }

                                  },
                                  error: function(xhr){
                                    alert("Sorry, there was an error. Please refresh the page and try again. #002");
                                    $('.user-login-back-to-page').show();
                                    console.log("ERROR");
                                    console.log(xhr.responseText);
                                  }
                                });

                              }else{
                                alert("Sorry, there was an error. Please refresh the page and try again. #003");
                                $('.user-login-back-to-page').show();
                                console.log("ERROR");
                                console.log(jqXHR);
                              }

                            },
                            error: function (xhr) {
                              alert("Sorry, there was an error. Please refresh the page and try again. #004");
                              $('.user-login-back-to-page').show();
                              console.log("ERROR");
                              console.log(xhr.responseText);
                            }
                          });

                        });

                      });

                    }else{ // IF NOT VALIDATED...

                      var plural = 0;
                      PANELS_NAV_CTN = (MAX_ONBOARDING_PANEL - 3);

                      $("div#onboarding-loading").css("display", "none");
                      $("button[data-nav='next']").removeClass("fired").addClass("grayed-out").attr('tabindex', '-1');

                      var errors = "";
                      if(!checkFirstAndLastName(ONBOARDING_firstName)){
                        errors += "Invalid first name. Make sure it's between 1 and 25 characters.\n";
                        plural++;
                      }
                      if(!checkFirstAndLastName(ONBOARDING_lastName)){
                        errors += "Invalid last name. Make sure it's between 2 and 25 characters.\n";
                        plural++;
                      }
                      if(!checkEmail(ONBOARDING_email)){
                        errors += "Invalid e-mail address. Make sure the e-mail address follows this format : example@example.com and is less than 100 characters.\n";
                        plural++;
                      }
                      if(!ONBOARDING_programTypeLabel || !ONBOARDING_userTypeLabel){
                        errors += "Please specify your program affiliation and user type.\n";
                        plural++;
                      }
                      if(!checkPasswords(ONBOARDING_PASSWORD, ONBOARDING_CONFIRM_PASSWORD)){
                        errors += "Invalid password. Please make sure your passwords match and contain a minimum of 6 characters.\n";
                        plural++;
                      }
                      if(plural == 1){
                        alert("Sorry, there is an error in the form :\n\n" + errors + "\nPlease fix the error and re-submit.");
                      }else{
                        alert("Sorry, there are some errors in the form :\n\n" + errors + "\nPlease fix the errors and re-submit.");
                      }
                      
                    }

                  }else{

                    // NEXT SLIDE

                    $activePanel
                    .removeClass("active-panel")
                    .find('[tabindex="0"]')
                    .attr('tabindex', '-1');

                    $nextFocus = $nextPanel
                    .addClass("active-panel")
                    .find('[tabindex="-1"]');

                    $nextPanel
                    .addClass("active-panel")
                    .find('[tabindex="-1"]')
                    .attr('tabindex', '0');

                    $('div#onboarding-panels-wrapper').animate({"min-height" : $nextPanel.attr("data-height") + "px" }, (FORM_ANIM_T-100), FORM_EASE);

                    $activePanel.add($nextPanel).animate({"left" : "-=100%"}, FORM_ANIM_T, FORM_EASE, function(){
                      $("button[data-nav='next']").removeClass("fired");
                      if($nextPanel.attr("data-valid") == "true"){
                        $('button[data-nav="next"]')
                        .removeClass("fired grayed-out")
                        .prop("disabled", false)
                        .attr('tabindex', '0');
                        $nextFocus.focus();
                      }else{
                        $nextPanel.find("input:eq(0), select:eq(0)").focus();
                        if($nextPanel.find('input[name="onboardingStudentNumber"]').length){
                          $('input[name="onboardingStudentNumber"]').trigger("keyup");
                        }
                      }
                    });

                  }

                  if(PANELS_NAV_CTN == (MAX_ONBOARDING_PANEL - 3)){
                    $('button[data-nav="next"]').html('<span aria-label="Sign up. Click this button to complete the sign up process.">Sign up <i class="icon-right-open"></i></span>').prop('type', 'submit');
                  }

                  if(PANELS_NAV_CTN == 0) $("button[data-nav='prev']").removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');

                  PANELS_NAV_CTN++;

                }else{

                  // STEP BY STEP VALIDATION
                  // ERROR MESSAGES (VD = VALIDATED)

                  var $VD_ACTIVE_PANEL = $("div.active-panel");
                  var err_message;

                  if($VD_ACTIVE_PANEL.is('[data-section="firstLastName"]')){
                    if(!checkFirstAndLastName($('input[name="onboardingFirstName"]').val().trim()) || !checkFirstAndLastName($('input[name="onboardingLastName"]').val().trim())){
                      err_message = "Invalid first name and/or last name. Make sure they are between 1 and 25 characters.";
                    }
                  }else if($VD_ACTIVE_PANEL.is('[data-section="email"]')){
                    if(!checkEmail($('input[name="onboardingEmail"]').val().trim())){
                      err_message = "Invalid e-mail address. Make sure the e-mail address follows this format : example@example.com and is less than 100 characters.";
                    }                    
                  }else if($VD_ACTIVE_PANEL.is('[data-section="password"]')){
                    if(!checkPasswords($('input[name="onboardingPassword"]').val(), $('input[name="onboardingConfirmPassword"]').val())){
                      err_message = "Invalid password. Please make sure your passwords match and contain a minimum of 6 characters.";
                    }
                  }

                  if(!err_message || err_message == ""){
                    swal("Oops!", "Invalid data. Please make sure you've filled out the fields correctly and try again.", "error");
                  }else{
                    $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                    $VD_ACTIVE_PANEL.attr("data-valid", false);
                    swal("Oops!", err_message, "error");
                  }

                }

              }
            }, 'div#onboarding-nav button[data-nav="next"]');

            // PREV SLIDE
            $("div#userLogin-modal-wrapper").on({
              click: function () {
                if(PANELS_NAV_CTN > 0 && !$(this).hasClass("fired")){

                  $(this).addClass("fired");
                  $("button[data-nav='next']").removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');

                  var $activePanel = $("div.onboarding-panel.active-panel");
                  var $prevPanel = $activePanel.prev(".onboarding-panel");

                  // Delete tooltips
                  $activePanel.find("input").parent("p").tooltip('destroy');

                  $activePanel
                  .removeClass("active-panel")
                  .find('[tabindex="0"]')
                  .attr('tabindex', '-1');

                  $prevPanel
                  .addClass("active-panel")
                  .find('[tabindex="-1"]')
                  .attr('tabindex', '0');

                  $('div#onboarding-panels-wrapper').animate({"min-height" : $prevPanel.attr("data-height") + "px" }, (FORM_ANIM_T-100), FORM_EASE);

                  $activePanel.add($prevPanel).animate({"left" : "+=100%"}, FORM_ANIM_T, FORM_EASE, function(){
                    $("button[data-nav='prev']").removeClass("fired");
                    $prevPanel.find("input:eq(0)").focus();
                  });

                  if(PANELS_NAV_CTN == (MAX_ONBOARDING_PANEL - 1)){
                    $("button[data-nav='next']").removeClass("grayed-out").attr('tabindex', '0');
                    //$(".publish-form").addClass("grayed-out");
                  }

                  if(PANELS_NAV_CTN == (MAX_ONBOARDING_PANEL - 2)){
                    $('button[data-nav="next"]').html('<span>Next <i class="icon-right-open"></i></span>').prop('type', 'button');
                  }

                  if(PANELS_NAV_CTN == 1) $(this).addClass("grayed-out").attr('tabindex', '-1');

                  PANELS_NAV_CTN--;

                }
              }
            }, 'div#onboarding-nav button[data-nav="prev"]');

            $onboardingFirstName = $('input[name="onboardingFirstName"]');
            $onboardingLastName = $('input[name="onboardingLastName"]');
            $onboardingEmail = $('input[name="onboardingEmail"]');

            $onboardingPassword = $('input[name="onboardingPassword"]');
            $onboardingConfirmPassword = $('input[name="onboardingConfirmPassword"]');

            var firstNameVal, lastNameVal;
            var $firstNameInput, $lastNameInput;
            var $passwordInput, $confirmPasswordInput;

            var $firstNameTT, $firstNameTT_panel, $lastNameTT, $lastNameTT_panel;
            var firstNameTT_string = "Your first name should be between 1 and 25 characters.";
            var lastNameTT_string = "Your last name should be between 1 and 25 characters.";
            var passwordTT_string = "Your passwords must match and contain 6 characters minimum.";

            /* ********** ACCESSIBILITY ********** */

            var $LOGIN_FORM_CONTAINER = $("#userLogin-modal-container");

            $LOGIN_FORM_CONTAINER.on("keydown", function(e){
                cv__document__keydown(e, $DOCUMENT, $LOGIN_FORM_CONTAINER, 'open',
                function(){
                    // Escape key
                    $LOGIN_FORM_CONTAINER
                    .find('#userLogin-close button')
                    .trigger('click');
                },
                function(){
                    // Enter key
                    if($('.passwordForgotten').length && $('.passwordForgotten').is(document.activeElement)){
                        $('.passwordForgotten').trigger('click');
                    }
                });
            });

            // FIRST NAME
            $("div#userLogin-modal-wrapper").on({
              keyup: function () {

                firstNameVal = $(this).val();

                if(firstNameVal == "" || $onboardingLastName.val() == ""){
                  $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }else if(firstNameVal != "" || $onboardingLastName.val() != ""){
                  if(checkFirstAndLastName(firstNameVal) && checkFirstAndLastName($onboardingLastName.val())){
                    $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                    $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                  }else{
                    $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                  }
                }

                if(checkFirstAndLastName(firstNameVal)){
                  cvDestroyAriaTooltipByElement($(this), $(this).parent("p"));
                  // $(this).parent("p").tooltip('destroy');
                }else{
                  if(!$(this).parents("div.onboarding-panel").find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($(this), $(this).parent("p"), firstNameTT_string, true);
                    // var element = $(this).parent("p");
                    // element.tooltip({trigger : 'manual', title : firstNameTT_string}).tooltip('show');
                    // cvSetupAriaLabelAndForceFocusByElement(element, firstNameTT_string + cvStashAriaLabel(element));
                  }
                }

              }
            }, 'form#onboarding-form input[name="onboardingFirstName"]');

            // FIRST NAME BLUR
            $("div#userLogin-modal-wrapper").on({
              blur: function () {

                var firstNamefieldVal = $(this).val();
                var $firstNamefieldTT = $('p[data-fieldName="userFirstName"]');
                var $firstNamefieldTT_panel = $firstNamefieldTT.parent("div.onboarding-panel");

                if(!checkFirstAndLastName(firstNamefieldVal)){
                  if(!$firstNamefieldTT_panel.find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($firstNamefieldTT, $firstNamefieldTT_panel, firstNameTT_string, false);
                    // $firstNamefieldTT.tooltip({trigger : 'manual', title : firstNameTT_string}).tooltip('show');
                  }
                }else{
                  if($firstNamefieldTT_panel.find("div.tooltip").length){
                    cvDestroyAriaTooltipByElement($firstNamefieldTT, $firstNamefieldTT_panel);
                    // $firstNamefieldTT.tooltip('destroy');
                  }
                }

                $lastNameInput = $('input[name="onboardingLastName"]').val();

                if(checkFirstAndLastName(firstNamefieldVal) && checkFirstAndLastName($lastNameInput)){
                  $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                }else{
                  $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }

              }
            }, 'form#onboarding-form input[name="onboardingFirstName"]');

            // LAST NAME
            $("div#userLogin-modal-wrapper").on({
              keyup: function () {

                lastNameVal = $(this).val();

                if(lastNameVal == "" || $onboardingFirstName.val() == ""){
                  $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");    
                }else if(lastNameVal != "" || $onboardingLastName.val() != ""){
                  if(checkFirstAndLastName($onboardingFirstName.val()) && checkFirstAndLastName(lastNameVal)){
                    $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                    $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                  }else{
                    $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                  }
                }

                if(checkFirstAndLastName(lastNameVal)){
                  cvDestroyAriaTooltipByElement($(this), $(this).parent("p"));
                  // $(this).parent("p").tooltip('destroy');
                }else{
                  if(!$(this).parents("div.onboarding-panel").find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($(this), $(this).parent("p"), lastNameTT_string, true)
                    // $(this).parent("p").tooltip({trigger : 'manual', title : lastNameTT_string}).tooltip('show');
                  }                  
                }

              }
            }, 'form#onboarding-form input[name="onboardingLastName"]');

            // LAST NAME BLUR
            $("div#userLogin-modal-wrapper").on({
              blur: function () {

                var lastNamefieldVal = $(this).val();
                var $lastNamefieldTT = $('p[data-fieldName="userLastName"]');
                var $lastNamefieldTT_panel = $lastNamefieldTT.parent("div.onboarding-panel");

                if(!checkFirstAndLastName(lastNamefieldVal)){
                  if(!$lastNamefieldTT_panel.find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($lastNamefieldTT, $lastNamefieldTT_panel, lastNameTT_string, false);
                    // $lastNamefieldTT.tooltip({trigger : 'manual', title : lastNameTT_string}).tooltip('show');
                  }
                }else{
                  if($lastNamefieldTT_panel.find("div.tooltip").length){
                    cvDestroyAriaTooltipByElement($lastNamefieldTT, $lastNamefieldTT_panel);
                    // $lastNamefieldTT.tooltip('destroy');
                  }
                }

                $firstNameInput = $('input[name="onboardingFirstName"]').val();

                if(checkFirstAndLastName(lastNamefieldVal) && checkFirstAndLastName($firstNameInput)){
                  $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                }else{
                  $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }

              }
            }, 'form#onboarding-form input[name="onboardingLastName"]');

            // PASSWORD
            $("div#userLogin-modal-wrapper").on({
              keyup: function () {

                if($(this).val() == "" || $onboardingConfirmPassword.val() == ""){
                  $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }else if($(this).val() != "" || $onboardingConfirmPassword.val() != ""){
                  if(checkPasswords($(this).val(), $onboardingConfirmPassword.val())){
                    $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                    $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                  }else{
                    $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                    $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                  }
                }

                if(checkPasswords($(this).val(), $onboardingConfirmPassword.val())){
                  cvDestroyAriaTooltipByElement($(this), $(this).parent("p"));
                  // $(this).parent("p").tooltip('destroy');
                }else{
                  if(!$(this).parents("div.onboarding-panel").find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($(this), $(this).parent("p"), passwordTT_string, true);
                    // $(this).parent("p").tooltip({trigger : 'manual', title : passwordTT_string}).tooltip('show');
                  }
                }

              }
            }, 'form#onboarding-form input[name="onboardingPassword"]');

            // PASSWORD BLUR
            $("div#userLogin-modal-wrapper").on({
              blur: function () {

                var $passwordfieldTT = $('p[data-fieldName="userPassword"]');
                var $passwordfieldTT_panel = $passwordfieldTT.parent("div.onboarding-panel");

                if(!checkPasswords($(this).val(), $onboardingConfirmPassword.val())){
                  if($onboardingConfirmPassword.val().length){ // If the "Confirm password" is filled
                    if(!$passwordfieldTT_panel.find("div.tooltip").length){
                      cvSetupAriaTooltipByElement($passwordfieldTT, $passwordfieldTT_panel, passwordTT_string, false);
                      // $passwordfieldTT.tooltip({trigger : 'manual', title : passwordTT_string}).tooltip('show');
                    }
                  }else{
                    cvDestroyAriaTooltipByElement($passwordfieldTT, $passwordfieldTT_panel);
                    // $passwordfieldTT.tooltip('destroy');
                  }
                }else{
                  if($passwordfieldTT_panel.find("div.tooltip").length){
                    cvDestroyAriaTooltipByElement($passwordfieldTT, $passwordfieldTT_panel);
                    // $passwordfieldTT.tooltip('destroy');
                  }
                }

                $confirmPasswordInput = $('input[name="onboardingConfirmPassword"]').val();

                if(checkPasswords($(this).val(), $onboardingConfirmPassword.val())){
                  $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                }else{
                  $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }

              }
            }, 'form#onboarding-form input[name="onboardingPassword"]');

            // CONFIRM PASSWORD
            $("div#userLogin-modal-wrapper").on({
              keyup: function () {

                if($(this).val() == "" || $onboardingPassword.val() == ""){
                  $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }else if($(this).val() != "" || $onboardingPassword.val() != ""){
                  if(checkPasswords($(this).val(), $onboardingPassword.val())){
                    $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                    $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                  }else{
                    $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                    $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                  }
                }

                if(checkPasswords($(this).val(), $onboardingPassword.val())){
                  cvDestroyAriaTooltipByElement($(this), $(this).parent("p"));
                  cvDestroyAriaTooltipByElement($onboardingPassword, $onboardingPassword.parent("p"));
                  // $(this).parent("p").tooltip('destroy');
                  // $onboardingPassword.parent("p").tooltip('destroy');
                }else{
                  if(!$(this).parents("div.onboarding-panel").find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($(this), $(this).parent("p"), passwordTT_string, true);
                    // $(this).parent("p").tooltip({trigger : 'manual', title : passwordTT_string}).tooltip('show');
                  }
                }

              }
            }, 'form#onboarding-form input[name="onboardingConfirmPassword"]');

            // CONFIRM PASSWORD BLUR
            $("div#userLogin-modal-wrapper").on({
              blur: function () {

                var $confirmPasswordfieldTT = $('p[data-fieldName="userConfirmPassword"]');
                var $confirmPasswordfieldTT_panel = $confirmPasswordfieldTT.parent("div.onboarding-panel");

                if(!checkPasswords($(this).val(), $onboardingConfirmPassword.val())){
                  if(!$confirmPasswordfieldTT_panel.find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($confirmPasswordfieldTT, $confirmPasswordfieldTT_panel, passwordTT_string, false);
                    // $confirmPasswordfieldTT.tooltip({trigger : 'manual', title : passwordTT_string}).tooltip('show');
                  }
                }else{
                  if($confirmPasswordfieldTT_panel.find("div.tooltip").length){
                    cvDestroyAriaTooltipByElement($confirmPasswordfieldTT, $confirmPasswordfieldTT_panel);
                    cvDestroyAriaTooltipByElement($onboardingPassword, $onboardingPassword.parent("p"));
                    // $confirmPasswordfieldTT.tooltip('destroy');
                  }
                }

                $passwordInput = $('input[name="onboardingPassword"]').val();

                if(checkPasswords($(this).val(), $onboardingConfirmPassword.val())){
                  $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                }else{
                  $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }

              }
            }, 'form#onboarding-form input[name="onboardingConfirmPassword"]');

            // EMAIL
            $("div#userLogin-modal-wrapper").on({
              keyup: function () {

                var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                if(!checkEmail($(this).val())){
                  $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }else if(checkEmail($(this).val())){
                  $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                }

              }
            }, 'form#onboarding-form input[name="onboardingEmail"]');

            // EMAIL
            $("div#userLogin-modal-wrapper").on({
              change: function () {

                var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                if(!checkEmail($(this).val())){
                  $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }else if(checkEmail($(this).val())){
                  $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                }

              }
            }, 'form#onboarding-form input[name="onboardingEmail"]');

            // PROGRAM TYPE
            $("div#userLogin-modal-wrapper").on({
              change: function () {
                $(this).find("option:not(:first-child)").prop("disabled", false).css("display", "block");
                $(this).find("option:selected").prop("disabled", true).css("display", "none");
                $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                $(this).parents("div.onboarding-panel").attr("data-valid", "true");
              }
            }, 'form#onboarding-form select[name="onboardingUserProgramType"]');

            // CAMPUS
            $("div#userLogin-modal-wrapper").on({
              change: function () {
                $(this).find("option:not(:first-child)").prop("disabled", false).css("display", "block");
                $(this).find("option:selected").prop("disabled", true).css("display", "none");
                $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                $(this).parents("div.onboarding-panel").attr("data-valid", "true");
              }
            }, 'form#onboarding-form select[name="onboardingUserCampusId"]');

            // USER TYPE
            $("div#userLogin-modal-wrapper").on({
              change: function () {
                $(this).find("option:not(:first-child)").prop("disabled", false).css("display", "block");
                $(this).find("option:selected").prop("disabled", true).css("display", "none");
                $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                $(this).parents("div.onboarding-panel").attr("data-valid", "true");
              }
            }, 'form#onboarding-form select[name="onboardingUserType"]');

            // STUDENT NUMBER
            $("div#userLogin-modal-wrapper").on({
              input: function () {

                var value = $(this).val();
                var err;

                if(!$.trim(value).length){
                  err = 'The student number is a required field and cannot be empty.'; 
                }

                if(!SN_REGEX.test(value)){
                  if(!err) err = 'The student number must only contain ' + SN_FORMAT_STRING + '.';                             
                }

                if((value.length != SN_L && SN_L != "0") || (SN_L == "0" && value.length > 99)){
                  var sLCharNb = (SN_L == "0" && value.length > 99) ? 'less than 99' : SN_L;
                  if(!err) err = 'The student number must be ' + sLCharNb + ' characters long.';
                }

                if(err){
                  if(!$SN_INPUT_TT_PANEL.find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($("#onboarding-sn"), $("#onboarding-sn").parent("p"), err, true);
                    //$SN_INPUT_TT.tooltip({trigger : 'manual', title : err}).tooltip('show');
                  }else{
                    if($SN_INPUT_TT.attr('data-original-title') != err){
                      cvSetupAriaTooltipByElement($("#onboarding-sn"), $("#onboarding-sn").parent("p"), err, true);
                      // $SN_INPUT_TT.attr('title', err).tooltip('fixTitle').tooltip('show');
                    }
                  }
                  $('button[data-nav="next"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }else{
                  cvDestroyAriaTooltipByElement($("#onboarding-sn"), $("#onboarding-sn").parent("p"));
                  // if($SN_INPUT_TT_PANEL.find("div.tooltip").length){
                  //   $SN_INPUT_TT.tooltip('destroy');
                  // }
                  $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                }

              }
            }, 'form#onboarding-form input[name="onboardingStudentNumber"]');

            // YEAR OF STUDY
            $("div#userLogin-modal-wrapper").on({
              change: function () {
                $(this).find("option:not(:first-child)").prop("disabled", false).css("display", "block");
                $(this).find("option:selected").prop("disabled", true).css("display", "none");
                $('button[data-nav="next"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                $(this).parents("div.onboarding-panel").attr("data-valid", "true");
              }
            }, 'form#onboarding-form select[name="onboardingYearOfStudy"]');

            $('div#userLogin-modal-wrapper').on("click", "div#graduatingThisYear div.customRadioSettings > div", function(){
              var $TARGET = $(this);
              $TARGET.parent('div.customRadioSettings').children().removeAttr('data-checked').removeClass("secondaryColorBGForced").find("i").remove();
              $TARGET.addClass("secondaryColorBGForced").attr("data-checked", "checked").prepend("<i class='fa fa-check'></i>");
            });

            // ========== SIGN UP ==========

            $("button[name='signUp']").on("click", function(e){

              e.preventDefault();

              $("form#login-form").find("button.submit-login").prop("disabled", true).attr('tabindex', '-1');

              // GET SIGN UP UI

              $.ajax({
                type: "POST",
                url: '/' + ROOT + '/inc/templates/handlebars/sign-up.php',
                dataType : 'text',
                success: function(signUpUI){
                  if(signUpUI){

                    $("div#userLogin-modal-wrapper").append(signUpUI);

                    $('input[name="signUpEmail"]').focus();

                    var $userLoginContainer = $("div#userLogin-modal-container");

                    $userLoginContainer.animate({"left" : "-" + ($userLoginContainer.width()/2)+"px"}, "fast", "easeOutExpo");
                    $("div#sign-up-wrapper").css({"top" : parseInt($userLoginContainer.css("top"), 10) + 40 + "px"}).animate({"left" : "50%"}, "fast", "easeOutExpo");

                    $signUpEmail = $('form#signUp-form input[name="signUpEmail"]');
                    $signUpConfirmEmail = $('form#signUp-form input[name="signUpConfirmEmail"]');

                  }
                },
                error : function(xhr){
                  swal("Error", "Could not load the 'Sign Up' form. Please try again or contact an admin.", "error");
                }

              });

            });

            // BACK TO LOGIN FORM
            $("div#userLogin-modal-wrapper").on({
              click: function () {

                $('form#signUp-form button[name="signUp-submit"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');

                $("form#login-form").find("button.submit-login").prop("disabled", false).attr('tabindex', '0');

                var $userLoginContainer = $("div#userLogin-modal-container");

                $userLoginContainer.animate({"left" : "50%"}, "fast", "easeOutExpo");
                $("div#sign-up-wrapper").animate({"left" : "100%", "opacity" : "0"}, "fast", "easeOutExpo", function(){
                  $(this).remove();
                  $('form#login-form').find('input[name="login-email"]').focus();
                });

              }
            }, 'form#signUp-form button[name="backToLoginForm"]');

           // SIGN UP
            $("div#userLogin-modal-wrapper").on({
              click: function () {

                var $signUp_form = $('form#signUp-form');

                var emailAddress = $signUp_form.find('input[name="signUpEmail"]').val().trim();

                $('div#signUpmessages').empty().css("display", "none");

                if(checkEmail(emailAddress)){

                  hasNewUserSignUpButtonBeenPressed = true; // ARIA support
                  cvDestroyAriaTooltipByElement($("#sign-up-email"), $("#sign-up-email").parent("p"));

                  $signUp_form.css({"display": "none", "opacity" : "0"});

                  $("div#signUp-loading").show(); // Loading animation

                  // POST EMAIL ADDRESS
                  $.ajax({
                    type: "POST",
                    url: DOMAIN + '/Skeddy/rest/gem/v1/institution/' + CAMPUS_ID + '/user/register/emailaddress/' + encodeURIComponent(emailAddress),
                    dataType : 'json',
                    success: function(signUpResponse){

                      console.log('signUpResponse');
                      console.log(signUpResponse);

                      var signUpSuccess = parse_OBJ(signUpResponse.i, "RegistrationResult");

                      console.log('signUpSuccess');
                      console.log(signUpSuccess);

                      if(signUpResponse && signUpSuccess == "Registration mail sent"){

                        $("div#signUp-loading").css({"display" : "none"});

                        $("div#signUp-panels-wrapper div#onboarding-panel-0").hide();
                        $("div#signUp-panels-wrapper div.sign-up-completed").show();

                        $signUp_form.addClass("signUp-completed").find('h3:eq(0), p.login-info, div#onboarding-nav button[name="signUp-submit"]').remove();

                        $signUp_form.css("display", "block").animate({'opacity' : '1'}, "fast");

                        // ARIA Support
                        setupAriaLabelAndFocusForSuccessfulSignUp();

                      }else{
                        if(signUpSuccess != "Registration mail sent"){
                          $("div#signUp-loading").css({"display" : "none"});
                          $signUp_form.css({"display": "block"}).animate({"opacity" : "1"}, 100, function(){
                            $('div#signUp-panels-wrapper').effect("shake");
                            $('div#signUpmessages').empty().css("display", "block").html('<strong>Error</strong> : Could not complete the registration. Make sure your e-mail address is valid and try again.');
                            setTimeout( function(){ $signUp_form.find('input[name="signUpEmail"]').focus(); }, 100);
                          });
                        }else{
                          swal("Error", "Sorry. There was an error. Please try again or contact an admin.", "error");
                        }
                      }

                    },
                    error : function(xhr){
                      var domainName = emailAddress.split('@')[1];
                      var errMessage = (xhr.responseText == "User already exists") ? "This account is already registered. Use the login form to login." : 'The domain name <strong>@' + domainName + '</strong> is <strong>not</strong> allowed. Please register with a different e-mail address or contact an admin.';
                      var ariaErrMessage = (xhr.responseText == "User already exists") ? "This account is already registered. Use the login form to login." : 'The domain name @' + domainName + ' is not allowed. Please register with a different e-mail address or contact an admin.';
                      $("div#signUp-loading").css({"display" : "none"});
                      $signUp_form.css({"display": "block"}).animate({"opacity" : "1"}, 100, function(){
                        $('div#signUp-panels-wrapper').effect("shake");
                        $('div#signUpmessages').empty().css("display", "block").html('<strong>Error</strong> : ' + errMessage);
                        $("#sign-up-email").attr("aria-label", ariaErrMessage + ". Check that you have the correct institutional email address and try again. Enter your institutional e-mail address.")
                        setTimeout( function(){ $signUp_form.find('input[name="signUpEmail"]').focus(); }, 100);
                      });
                    }

                  });

                }else{
                  $('button[name="signUp-submit"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  hasNewUserSignUpButtonBeenPressed = false;
                  cvSetupAriaTooltipByElement($("#sign-up-email"), $("#sign-up-email").parent("p"), "Error. Please enter a valid e-mail address.", true);
                  // 2018-05-24 (scott) removed swal() call and placed error message on input along with tooltip
                  // swal("Error", "Please enter a valid e-mail address.", "error");

                  // ARIA support
                  // setupAriaLabelAndFocusForSignUpError();
                }


              }
            }, 'form#signUp-form button[name="signUp-submit"]');

            $("div#userLogin-modal-wrapper").on("keydown", 'form#signUp-form input[name="signUpConfirmEmail"]', function(e) {

                var code = e.keyCode || e.which; 
                if (code  == 13) {
                  $('form#signUp-form button[name="signUp-submit"]').trigger("click");
                  e.preventDefault();
                  return false;
                }
              
            });

            // E-MAIL
            $("div#userLogin-modal-wrapper").on({
              keyup: function () {

                if($(this).val().trim() == "" || $signUpConfirmEmail.val().trim() == ""){
                  $('button[name="signUp-submit"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }else if($(this).val().trim() != "" || $signUpConfirmEmail.val().trim() != ""){
                  if(checkEmails($(this).val(), $signUpConfirmEmail.val())){
                    $('button[name="signUp-submit"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                    $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                  }else{
                    $('button[name="signUp-submit"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                    $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                  }
                }

                if(checkEmails($(this).val(), $signUpConfirmEmail.val())){
                  cvDestroyAriaTooltipByElement($(this), $(this).parent("p"));
                  // $("#sign-up-email").attr("aria-label", "Welcome to sign-up. Enter your institutional e-mail address and we'll send you an activation link."); // ARIA support
                  // $(this).parent("p").tooltip('destroy');
                }else{
                  if(!$(this).parents("div.onboarding-panel").find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($(this), $(this).parent("p"), "Your e-mails must match and be valid. Enter your institutional e-mail address.", true);
                    // $("#sign-up-email").attr("aria-label", "Your e-mails must match and be valid. Enter your institutional e-mail address."); // ARIA support
                    // $(this).parent("p").tooltip({trigger : 'manual', title : signUpEmailsStringTT}).tooltip('show');
                  }
                }

              }
            }, 'form#signUp-form input[name="signUpEmail"]');

            // E-MAIL BLUR
            $("div#userLogin-modal-wrapper").on({
              blur: function () {

                var $signUpfieldTT = $('p[data-fieldName="signUpEmail"]');
                var $signUpFieldTT_panel = $signUpfieldTT.parent("div.onboarding-panel");

                if(!checkEmails($(this).val(), $signUpConfirmEmail.val())){
                  if($signUpConfirmEmail.val().length){ // If the "Confirm e-mail" is populated
                    cvSetupAriaTooltipByElement($signUpfieldTT, $signUpFieldTT_panel, signUpEmailsStringTT, false);
                    // if(!$signUpFieldTT_panel.find("div.tooltip").length){
                    //   $signUpfieldTT.tooltip({trigger : 'manual', title : signUpEmailsStringTT}).tooltip('show');
                    // }
                  }else{
                    cvDestroyAriaTooltipByElement($signUpfieldTT, $signUpFieldTT_panel);
                    // $signUpfieldTT.tooltip('destroy');
                  }
                }else{
                  cvDestroyAriaTooltipByElement($signUpfieldTT, $signUpFieldTT_panel);
                  // if($signUpFieldTT_panel.find("div.tooltip").length){
                  //   $signUpfieldTT.tooltip('destroy');
                  // }
                }

                if(checkEmails($(this).val(), $signUpConfirmEmail.val())){
                  $('button[name="signUp-submit"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                }else{
                  $('button[name="signUp-submit"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }

              }
            }, 'form#signUp-form input[name="signUpEmail"]');

            // CONFIRM E-MAIL
            $("div#userLogin-modal-wrapper").on({
              keyup: function () {

                if($(this).val().trim() == "" || $signUpEmail.val().trim() == ""){
                  $('button[name="signUp-submit"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }else if($(this).val().trim() != "" || $signUpEmail.val().trim() != ""){
                  if(checkEmails($(this).val(), $signUpEmail.val())){
                    $('button[name="signUp-submit"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                    $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                  }else{
                    $('button[name="signUp-submit"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                    $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                  }
                }

                if(checkEmails($(this).val(), $signUpEmail.val())){
                  cvDestroyAriaTooltipByElement($(this), $(this).parent("p"));
                  cvDestroyAriaTooltipByElement($signUpEmail, $signUpEmail.parent("p"));
                  // $signUpEmail.parent("p").tooltip('destroy');
                  // $("#sign-up-confirm-email").attr("aria-label", "Please re-type your email address to confirm."); // ARIA support
                  // $(this).parent("p").tooltip('destroy');
                }else{
                  if(!$(this).parents("div.onboarding-panel").find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($(this), $(this).parent("p"), "Your e-mails must match and be valid. Please re-type your institutional email address to confirm.", true);
                    // $("#sign-up-confirm-email").attr("aria-label", "Your e-mails must match and be valid. Please re-type your institutional email address to confirm."); // ARIA support
                    // var arialLabel = "Your e-mails must match and be valid. Please re-type your institutional email address to confirm.";
                    // $(this).parent("p").tooltip({trigger : 'manual', title : signUpEmailsStringTT}).tooltip('show');
                  }
                }

              }
            }, 'form#signUp-form input[name="signUpConfirmEmail"]');

            // CONFIRM E-MAIL BLUR
            $("div#userLogin-modal-wrapper").on({
              blur: function () {

                var $confirmEmailfieldTT = $('p[data-fieldName="signUpConfirmEmail"]');
                var $confirmEmailfieldTT_panel = $confirmEmailfieldTT.parent("div.onboarding-panel");

                if(!checkEmails($(this).val(), $signUpConfirmEmail.val())){
                  cvSetupAriaTooltipByElement($confirmEmailfieldTT, $confirmEmailfieldTT_panel, signUpEmailsStringTT, false);
                  // if(!$confirmEmailfieldTT_panel.find("div.tooltip").length){
                  //   $confirmEmailfieldTT.tooltip({trigger : 'manual', title : signUpEmailsStringTT}).tooltip('show');
                  // }
                }else{
                  cvDestroyAriaTooltipByElement($confirmEmailfieldTT, $confirmEmailfieldTT_panel);
                  cvDestroyAriaTooltipByElement($signUpEmail, $signUpEmail.parent("p"));
                  // $signUpEmail.parent("p").tooltip('destroy');
                  // if($confirmEmailfieldTT_panel.find("div.tooltip").length){
                  //   $confirmEmailfieldTT.tooltip('destroy');
                  // }
                }

                if(checkEmails($(this).val(), $signUpConfirmEmail.val())){
                  $('button[name="signUp-submit"]').removeClass("grayed-out").prop("disabled", false).attr('tabindex', '0');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                }else{
                  $('button[name="signUp-submit"]').addClass("grayed-out").prop("disabled", true).attr('tabindex', '-1');
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }

              }
            }, 'form#signUp-form input[name="signUpConfirmEmail"]');

            // CONFIRM E-MAIL BLUR
            $("div#userLogin-modal-wrapper").on({
              paste: function () {
                var $target = $(this);
                var oldVal = $target.val();
                setTimeout(function(){
                  $target.val(oldVal);
                }, 0);
              }
            }, 'form#signUp-form input[name="signUpConfirmEmail"]');


            // ========== FORGOT PASSWORD ==========

            $("i.passwordForgotten").on("click", function(){

              $("form#login-form").find("button.submit-login").prop("disabled", true);

              $(this).tooltip('hide');

              var forgotPW_ui_data = {
                LOGIN_USERNAME_FORMAT : "Username"
              }

              // GET FORGOTTEN PASSWORD UI
              $.ajax({
                type: "POST",
                url: '/' + ROOT + '/inc/templates/handlebars/forgot-password.php',
                data: forgotPW_ui_data,
                dataType : 'text',
                success: function(forgotPasswordUI){
                  if(forgotPasswordUI){

                    $("div#userLogin-modal-wrapper").append(forgotPasswordUI);

                    $('input[name="forgotPasswordEmail"]').focus();

                    var $userLoginContainer = $("div#userLogin-modal-container");

                    $userLoginContainer.animate({"left" : "-" + ($userLoginContainer.width()/2)+"px"}, "fast", "easeOutExpo");
                    $("div#forgot-password-wrapper").css({"top" : parseInt($userLoginContainer.css("top"), 10) + 40 + "px"}).animate({"left" : "50%"}, "fast", "easeOutExpo");


                    /* ********** ACCESSIBILITY ********** */

                    var $FORGOTTEN_PASSWORD_CONTAINER = $("#forgot-password-wrapper");

                    $FORGOTTEN_PASSWORD_CONTAINER.on("keydown", function(e){
                        cv__document__keydown(e, $DOCUMENT, $FORGOTTEN_PASSWORD_CONTAINER, 'forgotPassword-modal-container',
                        function(){
                            // Escape key
                            $FORGOTTEN_PASSWORD_CONTAINER
                            .find('button[name="backToLoginForm"]')
                            .trigger('click');
                        },
                        function(){

                        });
                    });

                  }
                },
                error : function(xhr){
                  swal("Error", "Could not load the 'Reset your password' form. Please try again or contact an admin.", "error");
                }

              });

            });

            // ========== CREATE NEW PASSWORD ==========

            // NEW PASSWORD
            $("div#userLogin-modal-wrapper").on({
              keyup: function () {

                if($(this).val() == "" || $newConfirmPassword.val() == ""){
                  $('button[name="newPW-submit"]').addClass("grayed-out").prop("disabled", true);
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }else if($(this).val() != "" || $newConfirmPassword.val() != ""){
                  if(checkPasswords($(this).val(), $newConfirmPassword.val())){
                    $('button[name="newPW-submit"]').removeClass("grayed-out").prop("disabled", false);
                    $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                  }else{
                    $('button[name="newPW-submit"]').addClass("grayed-out").prop("disabled", true);
                    $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                  }
                }

                if(checkPasswords($(this).val(), $newConfirmPassword.val())){
                  cvDestroyAriaTooltipByElement($(this), $(this).parent("p"));
                  // $(this).parent("p").tooltip('destroy');
                }else{
                  if(!$(this).parents("div.onboarding-panel").find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($(this), $(this).parent("p"), passwordTT_string, true);
                    // $(this).parent("p").tooltip({trigger : 'manual', title : passwordTT_string}).tooltip('show');
                  }
                }

              }
            }, 'form#newPW-form input[name="newPassword"]');

            // NEW PASSWORD BLUR
            $("div#userLogin-modal-wrapper").on({
              blur: function () {

                var $passwordfieldTT = $('p[data-fieldName="newUserPassword"]');
                var $passwordfieldTT_panel = $passwordfieldTT.parent("div.onboarding-panel");

                if(!checkPasswords($(this).val(), $newConfirmPassword.val())){
                  if($newConfirmPassword.val().length){ // If the "Confirm password" is filled
                    if(!$passwordfieldTT_panel.find("div.tooltip").length){
                      cvSetupAriaTooltipByElement($passwordfieldTT, $passwordfieldTT_panel, passwordTT_string, false);
                      // $passwordfieldTT.tooltip({trigger : 'manual', title : passwordTT_string}).tooltip('show');
                    }
                  }else{
                    cvDestroyAriaTooltipByElement($passwordfieldTT, $passwordfieldTT_panel);
                    // $passwordfieldTT.tooltip('destroy');
                  }
                }else{
                  if($passwordfieldTT_panel.find("div.tooltip").length){
                    cvDestroyAriaTooltipByElement($passwordfieldTT, $passwordfieldTT_panel);
                    // $passwordfieldTT.tooltip('destroy');
                  }
                }

                if(checkPasswords($(this).val(), $newConfirmPassword.val())){
                  $('button[name="newPW-submit"]').removeClass("grayed-out").prop("disabled", false);
                  $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                }else{
                  $('button[name="newPW-submit"]').addClass("grayed-out").prop("disabled", true);
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }

              }
            }, 'form#newPW-form input[name="newPassword"]');

            // NEW CONFIRM PASSWORD
            $("div#userLogin-modal-wrapper").on({
              keyup: function () {

                if($(this).val() == "" || $newPassword.val() == ""){
                  $('button[name="newPW-submit"]').addClass("grayed-out").prop("disabled", true);
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }else if($(this).val() != "" || $newPassword.val() != ""){
                  if(checkPasswords($(this).val(), $newPassword.val())){
                    $('button[name="newPW-submit"]').removeClass("grayed-out").prop("disabled", false);
                    $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                  }else{
                    $('button[name="newPW-submit"]').addClass("grayed-out").prop("disabled", true);
                    $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                  }
                }

                if(checkPasswords($(this).val(), $newPassword.val())){
                  cvDestroyAriaTooltipByElement($(this), $(this).parent("p"));
                  cvDestroyAriaTooltipByElement($newPassword, $newPassword.parent("p"));
                  // $(this).parent("p").tooltip('destroy');
                  // $newPassword.parent("p").tooltip('destroy');
                }else{
                  if(!$(this).parents("div.onboarding-panel").find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($(this), $(this).parent("p"), passwordTT_string, true);
                    // $(this).parent("p").tooltip({trigger : 'manual', title : passwordTT_string}).tooltip('show');
                  }
                }

              }
            }, 'form#newPW-form input[name="newConfirmPassword"]');

            // NEW CONFIRM PASSWORD BLUR
            $("div#userLogin-modal-wrapper").on({
              blur: function () {

                var $confirmPasswordfieldTT = $('p[data-fieldName="newUserConfirmPassword"]');
                var $confirmPasswordfieldTT_panel = $confirmPasswordfieldTT.parent("div.onboarding-panel");

                if(!checkPasswords($(this).val(), $newConfirmPassword.val())){
                  if(!$confirmPasswordfieldTT_panel.find("div.tooltip").length){
                    cvSetupAriaTooltipByElement($confirmPasswordfieldTT, $confirmPasswordfieldTT_panel, passwordTT_string, false);
                    // $confirmPasswordfieldTT.tooltip({trigger : 'manual', title : passwordTT_string}).tooltip('show');
                  }
                }else{
                  cvDestroyAriaTooltipByElement($(this), $(this).parent("p"));
                  cvDestroyAriaTooltipByElement($newPassword, $newPassword.parent("p"));
                  // if($confirmPasswordfieldTT_panel.find("div.tooltip").length){
                  //   $confirmPasswordfieldTT.tooltip('destroy');
                  // }
                }

                if(checkPasswords($(this).val(), $newConfirmPassword.val())){
                  $('button[name="newPW-submit"]').removeClass("grayed-out").prop("disabled", false);
                  $(this).parents("div.onboarding-panel").attr("data-valid", "true");
                }else{
                  $('button[name="newPW-submit"]').addClass("grayed-out").prop("disabled", true);
                  $(this).parents("div.onboarding-panel").attr("data-valid", "false");
                }

              }
            }, 'form#newPW-form input[name="newConfirmPassword"]');

            // NEW PASSWORD BACK TO LOGIN

            $("div#userLogin-modal-wrapper").on({
              click: function () {

                $('form#newPW-form input[name="newPW-submit"]').addClass("grayed-out").prop("disabled", true);
                $('form#newPW-form').find("p.fieldset").tooltip('destroy');

                $("form#login-form").find("button.submit-login").prop("disabled", false);

                var $userLoginContainer = $("div#userLogin-modal-container");

                $userLoginContainer.animate({"left" : "50%"}, "fast", "easeOutExpo");
                $("div#new-password-wrapper").animate({"left" : "100%", "opacity" : "0"}, "fast", "easeOutExpo", function(){
                  $(this).remove();

                  $.ajax({
                    url: '/' + ROOT + '/inc/templates/ajax/user-logout.php',
                    type: "POST",
                    data: { data: "user-logout", API_TOKEN: USER_API_TOKEN },
                    dataType: "text",
                    success: function(data){
                      if(data == "allow"){
                        URL_ACTION_PARAM = '';
                        IS_NEW_PW = true;
                        $('form#login-form').find('input[name="login-email"]').focus();
                      }else{
                        swal("Error", "Could not log out. Please try again.", "error");
                      }
                    },
                    error: function(data){
                      swal("Error", "Could not log out. Please try again.", "error");
                    }
                  });

                });

              }
            }, 'form#newPW-form button[name="cancelToLoginForm"]');

            $("div#userLogin-modal-wrapper").on("keydown", 'form#newPW-form input[name="newConfirmPassword"]', function(e) {

                var code = e.keyCode || e.which; 
                if (code  == 13) {
                  $('form#newPW-form button[name="newPW-submit"]').trigger("click");
                  e.preventDefault();
                  return false;
                }
              
            });

            // SUBMIT NEW PASSWORD
            $("div#userLogin-modal-wrapper").on({
              click: function () {

                var $newPW_form = $('form#newPW-form');

                var newPassword = $newPW_form.find('input[name="newPassword"]').val();
                var newPasswordConfirm = $newPW_form.find('input[name="newConfirmPassword"]').val();

                $('div#forgottenPWmessages').empty().css("display", "none");

                if(checkPasswords(newPassword, newPasswordConfirm)){

                  if(typeof(ONBOARD_USER_ID) != "undefined" && typeof(USER_API_TOKEN) != "undefined" && ONBOARD_USER_ID && USER_API_TOKEN){
                    $newPW_form.css({"display": "none", "opacity" : "0"});
                    $("div#forgotten-pw-loading").show(); // Loading animation
                  }else{
                    swal("Error", "Could not create the new password. Please try again. #001", "error");
                    return false;
                  }

                  $.when(
                    $.ajax({
                      type : 'GET',
                      url : DOMAIN + '/Skeddy/rest/gem/v1/user/' + ONBOARD_USER_ID + '?sname=CampusSchema&apitoken=' + USER_API_TOKEN,
                      dataType : 'json'
                    })
                  ).then(function(userOBJ){

                    var userOBJ_currentPw = parse_OBJ(userOBJ.i, "Password");

                    // Appending password
                    userOBJ.i.push({"k" : "Password", "v" : newPassword});

                    $.ajax({
                      headers: { 
                          "Accept" : "application/json",
                          "Content-Type": "application/json"
                      },
                      type : 'PUT',
                      url : DOMAIN + '/Skeddy/rest/gem/v1/user/' + ONBOARD_USER_ID + '?sname=CampusSchema&apitoken=' + USER_API_TOKEN,
                      data : JSON.stringify(userOBJ),
                      dataType : 'json',
                      contentType: "application/json",
                      success: function (data, status, jqXHR) {

                        if(status == "success"){

                          // LOGOUT

                          $.ajax({
                            url: '/' + ROOT + '/inc/templates/ajax/user-logout.php',
                            type: "POST",
                            data: { data: "user-logout", API_TOKEN: USER_API_TOKEN },
                            dataType: "text",
                            success: function(data_logout){
                              if(data_logout == "allow"){

                                URL_ACTION_PARAM = '';
                                IS_NEW_PW = true;

                                $("div#forgotten-pw-loading").css({"display" : "none"});

                                $("div#forgottenPW-panels-wrapper div#onboarding-panel-7").hide();
                                $("div#forgottenPW-panels-wrapper div.forgot-pw-completed").show();

                                $newPW_form.addClass("forgotten-pw-completed").find('h3:eq(0), p.login-info, div#onboarding-nav button[name="newPW-submit"]').remove();

                                $newPW_form.css("display", "block").animate({'opacity' : '1'}, "fast");

                              }else{
                                swal("Error", "Sorry, there was an error. Please refresh the page and try again. #002", "error");
                              }
                            },
                            error: function(data_logout){
                              swal("Error", "Sorry, there was an error. Please refresh the page and try again. #003", "error");
                            }
                          });

                        }else{
                          swal("Error", "Sorry, there was an error. Please refresh the page and try again. #004", "error");
                        }

                      },
                      error: function (xhr) {
                        swal("Error", "Sorry, there was an error. Please refresh the page and try again. #005", "error");
                        console.log("ERROR");
                        console.log(xhr.responseText);
                      }
                    });

                  });

                }else{
                  swal("Error", passwordTT_string, "error");
                }

              }
            }, 'form#newPW-form button[name="newPW-submit"]');


        });

        // EMAIL
        $("div#userLogin-modal-wrapper").on({
          keyup: function () {

            if(!$(this).val().trim().length){
              $('button[name="forgotPW-submit"]').addClass("grayed-out").prop("disabled", true);
            }else{
              $('button[name="forgotPW-submit"]').removeClass("grayed-out").prop("disabled", false);
            }

          }
        }, 'form#forgottenPW-form input[name="forgotPasswordEmail"]');

        // SUBMIT FORGOTTEN PASSWORD E-MAIL
        $("div#userLogin-modal-wrapper").on({
          click: function () {

            var $forgottenPW_form = $('form#forgottenPW-form');

            var userId = $forgottenPW_form.find('input[name="forgotPasswordEmail"]').val().trim();

            $('div#forgottenPWmessages').empty().css("display", "none");

            if(userId.length){

              $forgottenPW_form.css({"display": "none", "opacity" : "0"});

              $("div#forgotten-pw-loading").show(); // Loading animation

              // POST USERID
              $.ajax({
                type: "POST",
                url: DOMAIN + '/Skeddy/rest/gem/v1/institution/'+CAMPUS_ID+'/user/'+userId+'/mail/template/type/PWRESET',
                dataType : 'json',
                success: function(forgotPasswordUI){

                  var nbRecipients = parse_OBJ(forgotPasswordUI.i, "NumberOfRecipients");

                  if(forgotPasswordUI && nbRecipients == "1"){

                    $("div#forgotten-pw-loading").css({"display" : "none"});

                    $("div#forgottenPW-panels-wrapper div#onboarding-panel-0").hide();
                    $("div#forgottenPW-panels-wrapper div.forgot-pw-completed").show();

                    $forgottenPW_form.addClass("forgotten-pw-completed").find('h3:eq(0), p.login-info, div#onboarding-nav button[name="forgotPW-submit"]').remove();

                    $forgottenPW_form.css("display", "block").animate({'opacity' : '1'}, "fast");
                    $("#login-button").attr("aria-label", "Sent! Check your email for instructions on how to reset your password. Click login to try again.");
                    $("#login-button").focus();

                  }else{
                    if(nbRecipients == "0"){
                      $("div#forgotten-pw-loading").css({"display" : "none"});
                      $forgottenPW_form.css({"display": "block"}).animate({"opacity" : "1"}, 100, function(){
                        $('div#forgottenPW-panels-wrapper').effect("shake");
                        $('div#forgottenPWmessages').empty().css("display", "block").html('<strong>Error</strong> : This user does not exist on this system.');
                        setTimeout( function(){ $("form#forgottenPW-form").find('input[name="forgotPasswordEmail"]').focus(); }, 100);
                      });
                    }else{
                      swal("Error", "Sorry. There was an error. Please try again or contact an admin.", "error");
                    }
                  }
                },
                error : function(xhr){
                  $("div#forgotten-pw-loading").css({"display" : "none"});
                  $forgottenPW_form.css({"display": "block"}).animate({"opacity" : "1"}, 100, function(){
                    $('div#forgottenPW-panels-wrapper').effect("shake");
                    $('div#forgottenPWmessages').empty().css("display", "block").html('<strong>Error</strong> : Could not retrieve user data (ERR. #003).');
                    $("form#forgottenPW-form").find('input[name="forgotPasswordEmail"]').attr("aria-label", "We're unable to find a user account matching the text you entered. Please verify you are entering the correct user account and try again.");
                    setTimeout( function(){ $("form#forgottenPW-form").find('input[name="forgotPasswordEmail"]').focus(); }, 100);
                  });
                }

              });

            }else{
              $('button[name="forgotPW-submit"]').addClass("grayed-out").prop("disabled", true);
              swal("Error", "Please enter a valid User ID.", "error");
            }

          }
        }, 'form#forgottenPW-form button[name="forgotPW-submit"]');


        // SUBMIT RESET PASSWORD / PASSWORD RESET
        $("div#userLogin-modal-wrapper").on({
          click: function () {

            var $resetPW_form = $('form#resetPW-form');

            var userEmail = $resetPW_form.find('button[name="resetPW-submit"]').attr("data-email");

            $('div#resetPWmessages').empty().css("display", "none");

            if(userEmail && userEmail.length){

              $resetPW_form.css({"display": "none", "opacity" : "0"});

              $("div#reset-pw-loading").show(); // Loading animation

              // POST USERID
              $.ajax({
                type: "POST",
                url: DOMAIN + '/Skeddy/rest/gem/v1/institution/'+CAMPUS_ID+'/user/'+userEmail+'/mail/template/type/PWRESET',
                dataType : 'json',
                success: function(resetPasswordUI){

                  console.log("RESPONSE RESET PW");
                  console.log(resetPasswordUI);

                  var nbRecipients = parse_OBJ(resetPasswordUI.i, "NumberOfRecipients");

                  if(resetPasswordUI && nbRecipients == "1"){

                    $("div#reset-pw-loading").css({"display" : "none"});

                    $("div#resetPW-panels-wrapper, div#resetPW-panels-wrapper div.reset-pw-completed").show();

                    $resetPW_form.addClass("reset-pw-completed").find('h3:eq(0), p.login-info, div#onboarding-nav button[name="resetPW-submit"]').remove();

                    $resetPW_form.css("display", "block").animate({'opacity' : '1'}, "fast");

                  }else{
                    if(nbRecipients == "0"){
                      $("div#reset-pw-loading").css({"display" : "none"});
                      $resetPW_form.css({"display": "block"}).animate({"opacity" : "1"}, 100, function(){
                        $('div#forgot-password-wrapper').effect("shake");
                        $('div#resetPWmessages').empty().css("display", "block").html('<strong>Error</strong> : Could not retrieve user data (ERR. #001).').show();
                      });
                    }else{
                      swal("Error", "Sorry. There was an error. Please try again or contact an admin.", "error");
                    }
                  }
                },
                error : function(xhr){
                  $("div#reset-pw-loading").css({"display" : "none"});
                  $resetPW_form.css({"display": "block"}).animate({"opacity" : "1"}, 100, function(){
                    $('div#forgot-password-wrapper').effect("shake");
                    $('div#resetPWmessages').empty().css("display", "block").html('<strong>Error</strong> : Could not retrieve user data (ERR. #002).').show();
                  });
                }

              });

            }else{
              $('button[name="resetPW-submit"]').addClass("grayed-out").prop("disabled", true);
              swal("Error", "Please enter a valid User ID.", "error");
            }

          }
        }, 'form#resetPW-form button[name="resetPW-submit"]');


        $("div#userLogin-modal-wrapper").on("keydown", 'form#forgottenPW-form input[name="forgotPasswordEmail"]', function(e) {

            var code = e.keyCode || e.which; 
            if (code  == 13) {
              $('form#forgottenPW-form button[name="forgotPW-submit"]').trigger("click");
              e.preventDefault();
              return false;
            }
          
        });

        // BACK TO LOGIN FORM FROM FORGOT PASSWORD
        $("div#userLogin-modal-wrapper").on({
          click: function () {

            $('form#forgottenPW-form input[name="forgotPW-submit"]').addClass("grayed-out").prop("disabled", true);

            $("form#login-form").find("button.submit-login").prop("disabled", false);

            var $userLoginContainer = $("div#userLogin-modal-container");

            $userLoginContainer.animate({"left" : "50%"}, "fast", "easeOutExpo");
            $("div#forgot-password-wrapper").animate({"left" : "100%", "opacity" : "0"}, "fast", "easeOutExpo", function(){
              $(this).remove();
              $('form#login-form').find('input[name="login-email"]').focus();
            });

          }
        }, 'form#forgottenPW-form button[name="backToLoginForm"]');

        // BACK TO LOGIN FORM FROM RESET PASSWORD
        $("div#userLogin-modal-wrapper").on({
          click: function () {

            $('form#resetPW-form button[name="resetPW-submit"]').addClass("grayed-out").prop("disabled", true);

            $("form#login-form").find("button.submit-login").prop("disabled", false);

            var $userLoginContainer = $("div#userLogin-modal-container");

            $userLoginContainer.animate({"left" : "50%"}, "fast", "easeOutExpo");
            $("div#forgot-password-wrapper").animate({"left" : "100%", "opacity" : "0"}, "fast", "easeOutExpo", function(){
              $(this).remove();
              $('form#login-form').find('input[name="login-email"]').focus();
            });

          }
        }, 'form#resetPW-form button[name="backToLoginForm"]');

        // ********** SUBMIT FORM **********

        
        var AUTH_METHOD = "user-login-external";

        function checkFirstAndLastName(name){
          if(name && name.length !== 0 && name.trim().length){
            if(name.length >= 1 && name.length < 25){
              return true;
            }
            return false;
          }
          return false;
        }

        function checkEmail(email){
          if(email && email.length !== 0 && email.trim().length){
            var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if(email.length <= 100 && regex.test(email)){
              return true;
            }
            return false;
          }
          return false;
        }

        function checkEmails(email, confirmEmail){
          if(email && email.length !== 0 && email.trim().length){
            if(confirmEmail && confirmEmail.length !== 0 && confirmEmail.trim().length){
              var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if(email == confirmEmail && regex.test(email) && regex.test(confirmEmail) && email.length <= 100){
                return true;
              }
              return false;
            }
            return false;
          }
          return false;
        }

        function checkPasswords(password, confirmPassword){
          if(AUTH_METHOD == "user-login-basic"){
            if(password && password.length !== 0 && password.length >= 6){
              if(confirmPassword && confirmPassword.length !== 0 && confirmPassword.length >= 6){
                if(password == confirmPassword){
                  return true;
                }
                return false;
              }
              return false;
            }
            return false;
          }else{
            return true;
          }
        }

        // PARSE "I" OBJ OF GEM
        function parse_OBJ(array, key){
          for(j = 0; j <= array.length; j++){
            if(array[j].k == key){
              return array[j].v;
              break;
            }
            if(j == (array.length-1)){
              return false;
            }
          }
        }


        // ----------------------------------------------------------------------------------------------------
        // CampusVibe Library ? (is there a better place to define this that already exists?)
        // ----------------------------------------------------------------------------------------------------

        // Insert a console.log(text) statement only if we're in the development environment (quite/silent otherwise)
        function cvConsoleLog(text) {

            if (!text) {
                console.log("> cv-error: text is undefined (trace follows).");
                console.trace();
                return;
            }

                    }


        // Insert a console.log(text) statement if we're in developemnt, otherwise 
        // Insert a console.log(nonDeveMessage) statement
        function cvConsoleLogProd(text, nonDeveMessage) {

            if (!text) {
                console.log("> cv-error: text is undefined (trace follows).");
                console.trace();
                return;
            }

            if (!nonDevMessage) {
                console.log("> cv-error: nonDevMessage is undefined (trace follows).");
                console.trace();
                return;
            }

            console.log(nonDevMessage);        }

        // Display stack trace in console (only if we're in development)
        function cvTrace() {

                    }

        // Display a console log entry followed by stack trace
        function cvConsoleLogTrace(text) {

            if (!text) {
                console.log("> cv-error: text is undefined");
                console.trace();
                return;
            }

            cvConsoleLog(text);
            cvTrace();
        }

        // dump an element's attributes to the console
        function cvConsoleLogAttributes(element, elementName) {

          if (!element) {
              console.log('> cv-log: error, element is undefined.');
              cvTrace();
              return;
          }

          if (!elementName) {
              console.log('> cv-log: error, you must specify a name for the element.');
              cvTrace();
              return;
          }

          var countAttributes = 0;
          $.each(element.attributes, function() {
            if (this.specified)  {
              console.log('> cv-log: {attr} ' + elementName + '.' + this.name + '="' + this.value + '"');
              countAttributes++;
            }
          });

          if (countAttributes < 1) {
              console.log('> cv-log: {attr} ' + elementName + ' has no attributes');
          }
        }

        // ----------------------------------------------------------------------------------------------------
        // ARIA Support
        // ----------------------------------------------------------------------------------------------------

        // focus on the element specified by id
        function cvForceFocusById(elementId) {

            if (!elementId)
            {
                cvConsoleLog('> cv-error: elementId is null or empty (trace follows).');
                cvTrace();
                return;
            }

            var element = $("#" + elementId);

            if (!element || !element.length || element.length === 0){
                cvConsoleLog('> cv-error: unable to find element with id="' + elementId + '" (trace follows).');
                cvTrace();
                return;
            }

            cvConsoleLog('> cv-log: forcing focus to element id="' + elementId + '"');
            cvTrace();

            setTimeout(function() {
                element.focus();
            }, 0);
        }

        // focus on the element specified by name
        function cvForceFocusByName(elementName) {

            if (!elementName)
            {
                cvConsoleLog('> cv-error: elementName is null or empty (trace follows).');
                cvTrace();
                return;
            }

            var element = $('[name="' + elementName + '"]');
            if (!element || !element.length || element.length === 0){
                cvConsoleLog('> cv-error: unable to find element with name="' + elementName + '" (trace follows).');
                cvTrace();
                return;
            }

            cvConsoleLog('> cv-log: forcing focus to element name="' + elementName + '"');
            cvTrace();

            setTimeout(function() {
                element.focus();
            }, 0);
        }

        // focus on the element specified
        function cvForceFocus(element) {

            if (!element || !element.length || element.length === 0) {
                cvConsoleLog('> cv-error: element is undefined, null or has zero length (trace follows).');
                cvTrace();
                return;
            }

            var elementDescription = cvGetElementDescription(element);

            cvConsoleLog('> cv-log: forcing focus to element ' + elementDescription);

            setTimeout(function() {
                element.focus();
            }, 0);
        }

        // get some descriptive information on the element (id or name)
        function cvGetElementDescription(element) {

            if (!element) {
                cvConsoleLog('> cv-error: element is undefined (trace follows).');
                cvTrace();
                return "{error-1}";
            }

            if (!element.length) {
                cvConsoleLog('> cv-error: element.length is undefined, possibly not an HTML element (trace follows).');
                cvTrace();
                return "{error-2}";
            }

            if (element.length === 0) {
                cvConsoleLog('> cv-error: element has zero length (trace follows).');
                cvTrace();
                return "{error-3}";
            }

            var elementId = element.attr("id");
            if (!elementId) {
                var elementName = element.attr("name");
                if (!elementName) {
                    return "{unknown}";

                } else {
                    return 'name="' + elementName + '"';
                }
            } else {
                return 'id="' + elementId + '"';
            }

            // should never be here, but if we are we know we missed something when updating the previous block
            return "{null}"; 
        }

        // assign new aria-label text to an element then pass focus to the element
        function cvSetupAriaLabelAndForceFocusByElement(element, ariaLabelText) {

            if (!element) {
                cvConsoleLog('> cv-error: element is undefined (trace follows).');
                cvTrace();
                return;
            }

            if (!element.length) {
                cvConsoleLog('> cv-error: element.length is undefined, possibly not an HTML element (trace follows).');
                cvTrace();
                return;
            }

            if (element.length === 0) {
                cvConsoleLog('> cv-error: element has zero length (trace follows).');
                cvTrace();
                return;
            }

            element.attr("aria-label", ariaLabelText);
            cvForceFocus(element);
        }

        // assign new aria-label text to the element specified by id then pass focus to the element
        function cvSetupAriaLabelAndForceFocusByElementId(elementId, ariaLabelText) {


            if (!elementId)
            {
                cvConsoleLog('> cv-error: elementId is null or empty (trace follows).');
                cvTrace();
                return;
            }

            if (!ariaLabelText) {
                cvConsoleLog('> cv-error: ariaLabelText is null or empty (trace follows).');
                cvTrace();
                return;
            }

            var element = $("#" + elementId);
            if (!element || !element,length || element.length === 0){
                cvConsoleLog('> cv-error: unable to find element with id="' + elementId + '" (trace follows).');
                cvTrace();
                return;
            }

            cvConsoleLog('> cv-log: element id="' + elementId + '" aria-label="' + ariaLabelText + '"');
            element.attr("aria-label", ariaLabelText);

            cvConsoleLog('> cv-log: forcing focus to element id="' + elementId + '"');

            setTimeout(function() {
                element.focus();
            }, 0);
        }

        // stash an element's aria-label; restore later using pop stash
        function cvStashAriaLabel(element) {

            if (!element) {
                cvConsoleLog('> cv-error: element is undefined (trace follows).');
                cvTrace();
                return;
            }

            if (!element.length) {
                cvConsoleLog('> cv-error: element.length is undefined, possibly not an HTML element (trace follows).');
                cvTrace();
                return;
            }

            if (element.length === 0) {
                cvConsoleLog('> cv-error: element has zero length (trace follows).');
                cvTrace();
                return;
            }

            var stashedAriaLabel = element.attr("data-aria-label-stash");
            if (!stashedAriaLabel) {

                var ariaLabel = element.attr("aria-label");
                if (!ariaLabel) {
                    ariaLabel = ""; // we'll stash an empty string
                }

                cvConsoleLog('> cv-log: data-aria-label-stash="' + ariaLabel + '" for element ' + cvGetElementDescription(element));
                element.attr("data-aria-label-stash", ariaLabel);

                return ariaLabel;
            } else {
                cvConsoleLog('> cv-error: stash already exists (data-aria-label-stash="' + ariaLabel + '") for element ' + cvGetElementDescription(element) + ' (trace follows).');
                cvTrace();
                return stashedAriaLabel;
            }
        }

        // restore an element's aria-label from stash
        function cvPopAriaLabelStash(element) {

            if (!element) {
                cvConsoleLog('> cv-error: element is undefined (trace follows).');
                cvTrace();
                return;
            }

            if (!element.length) {
                cvConsoleLog('> cv-error: element.length is undefined, possibly not an HTML element (trace follows).');
                cvTrace();
                return;
            }

            if (element.length === 0) {
                cvConsoleLog('> cv-error: element has zero length (trace follows).');
                cvTrace();
                return;
            }

            var stashedAriaLabel = element.attr("data-aria-label-stash");
            if (!stashedAriaLabel) {
                var elementDescription = cvGetElementDescription(element);
                cvConsoleLog('> cv-error: data-aria-label-stash not found for element ' + elementDescription + ' (trace follows).');
                cvTrace();
                return; // nothing to stash
            }

            cvConsoleLog('> cv-log: (pop) data-aria-label-stash="' + stashedAriaLabel + '" for element ' + cvGetElementDescription(element));
            element.attr("data-aria-label-stash", ""); // effectively empty the stash (without removing the attribute)
            element.attr("aria-label", stashedAriaLabel);
        }

        // for error handling : prepend ttText to the elements existing aria-label; add tooltip to the element then pass focus to the element
        function cvSetupAriaTooltipByElement(ariaElement, ttElement, ttText, isFocusOnAriaElement) {

            if (!ariaElement) {
                cvConsoleLog('> cv-error: ariaElement is undefined (trace follows).');
                cvTrace();
                return;
            }

            if (!ariaElement.length) {
                cvConsoleLog('> cv-error: ariaElement.length is undefined, possibly not an HTML ariaElement (trace follows).');
                cvTrace();
                return;
            }

            if (ariaElement.length === 0) {
                cvConsoleLog('> cv-error: ariaElement has zero length (trace follows).');
                cvTrace();
                return;
            }

            if (!ttElement) {
                cvConsoleLog('> cv-error: ttElement is undefined (trace follows).');
                cvTrace();
                return;
            }

            if (!ttElement.length) {
                cvConsoleLog('> cv-error: ttElement.length is undefined, possibly not an HTML ttElement (trace follows).');
                cvTrace();
                return;
            }

            if (!ttText) {
                cvConsoleLog('> cv-error: ttText is null or empty (trace follows).');
                cvTrace();
                return;
            }

            var doThis9999 = false;
            if (doThis9999) {
                ttElement.tooltip({trigger : 'manual', title : ttText}).tooltip('show');
                ariaElement.attr("aria-label", ttText + cvStashAriaLabel(ariaElement));
                if (isFocusOnAriaElement) {
                    cvForceFocus(ariaElement);
                }
            }
        }

        // for error handling : clear the error by restoring original aria-label and destroying tooltip
        function cvDestroyAriaTooltipByElement(ariaElement, ttElement) {

            if (!ariaElement) {
                cvConsoleLog('> cv-error: ariaElement is undefined (trace follows).');
                cvTrace();
                return;
            }

            if (!ariaElement.length) {
                cvConsoleLog('> cv-error: ariaElement.length is undefined, possibly not an HTML ariaElement (trace follows).');
                cvTrace();
                return;
            }

            if (ariaElement.length === 0) {
                cvConsoleLog('> cv-error: ariaElement has zero length (trace follows).');
                cvTrace();
                return;
            }

            if (!ttElement) {
                cvConsoleLog('> cv-error: ttElement is undefined (trace follows).');
                cvTrace();
                return;
            }

            if (!ttElement.length) {
                cvConsoleLog('> cv-error: ttElement.length is undefined, possibly not an HTML ttElement (trace follows).');
                cvTrace();
                return;
            }

            if (ttElement.length === 0) {
                cvConsoleLog('> cv-error: ttElement has zero length (trace follows).');
                cvTrace();
                return;
            }

            cvPopAriaLabelStash(ariaElement);
            if (!ttElement.tooltip) {
                cvConsoleLog('> cv-error: no tooltip found for element ' + cvGetElementDescription(ttElement) + ' (trace follows).');
                return; // no tooltip to destroy
            }
            ttElement.tooltip('destroy');
        }

        // ----------------------------------------------------------------------------------------------------
        // ARIA SUPPORT - less generic (earlier) functions
        // ----------------------------------------------------------------------------------------------------
        function setupAriaLabelAndFocusForSuccessfulSignUp() {
            var ariaLabelText = "Sign-up complete. We've sent you an email with login instructions. Click this button to return to the login page.";
            $("#sign-up-back-to-login-button").attr("aria-label", ariaLabelText);

            cvForceFocusById("sign-up-back-to-login-button");

            // setTimeout(function(){
            //     $("#sign-up-back-to-login-button").focus();
            // }, 0);
        }

        function ariaSupportPageAnchorTopOnFocusOut() {
            cvForceFocusById("sign-up-email");

            // setTimeout(function (){
            //     $("#sign-up-email").focus();
            // }, 0);
        }

        function ariaSupportPageAnchorBottomOnFocusOut() {
            cvForceFocusById("sign-up-email");

            // setTimeout(function (){
            //     $("#sign-up-email").focus();
            // }, 0);
        }


        </script>  
  <a tabindex="0" href="#cl-landing-content-wrapper" class="flat-button vibrant-blue btn-link cv-skip-link">Jump to main content</a> 
  <!--[if lt IE 7]>
          <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
      <![endif]--> 
  <script>
    window.fbAsyncInit = function() {
      FB.init({
        appId      : FACEBOOK_APP_ID,
        xfbml      : true,
        version    : 'v2.6'
      });
    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "//connect.facebook.net/en_US/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script> 
  <nav class="navbar navbar-inverse navbar-fixed-top navbar-small navbar-fullscreen" role="navigation"> 
   <div class="container"> 
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> 
    <div class="navbar-header campus-landing-page-brand"> 
     <div id="brand_wrapper"> 
      <a tabindex="0" href="/campusvibe/campus/b3dec320-64b6-413d-bb5e-dcd3afa78737" id="university-logo" title="UWSA Hub" style="background-image:url(https://www.campusvibe.ca/Skeddy/rest/gem/v1/image/194f8299-e57c-4cd0-afab-7bdee314b4f9?sname=CampusSchema&amp;apitoken=9a3111648e5176ebc2ac4a1d15c5e8dd95261e8b);" aria-label="UWSA Hub Logo Image. Click this link to return to the home page."></a> 
     </div> 
     <div id="campus-title"> 
      <div id="select-campus-title" class="single-campus"> 
       <div class="btn-group"> 
        <!-- <button type="button" class="btn dropdown-toggle btn-campus-title" data-toggle="dropdown" aria-expanded="false" tabindex="-1"> --> 
        <h1>UWSA Hub</h1> 
        <h4><i class="icon-bank" style="margin:1px 3px 0 0;"></i> University of Windsor</h4> 
        <!-- </button> --> 
       </div> 
      </div> 
      <!-- / #select-campus-title --> 
     </div> 
     <div id="navbar"> 
      <div class="navbar-right"> 
       <script id="select-campus-list-template" type="text/x-handlebars-template">

        {{#ifCanSignUp}}
          <div id="navbar-register">Don&#39;t have an account? <button type="button" name="navbar_register" class="btn-link primaryColor" aria-label="Don't have an account? Click to sign-up."><i class="fa fa-sign-in"></i> Sign up</button> &bull; </div>
        {{/ifCanSignUp}}

          {{#ifPollsAreEnabled}}
            <div class="navbar-inline-block" data-navbarBlock="polls">
              <a tabindex="0" href="/campusvibe/feeds/b3dec320-64b6-413d-bb5e-dcd3afa78737/mypolls" class="buttonWithBorder flat-button" target="_top" data-toggle="tooltip" data-placement="bottom" title="My polls" aria-label="My polls"><i class="icon-chart-bar-1" aria-hidden="true"></i> <span class="nb-polls-pill nb-polls-pill-hide"></span></a>
            </div>
          {{/ifPollsAreEnabled}}
          
          {{#ifSupportEmail}}
            <div id="email-support">
              <a tabindex="0" href="mailto:{{supportEmail}}" class="buttonWithBorder flat-button" target="_top" data-toggle="tooltip" data-placement="bottom" title="Need help? Contact {{supportEmail}}" aria-label="Need help? Contact {{supportEmail}}, clicking this will open your default email program and will likely leave this page."><i class="fa fa-envelope" aria-hidden="true"></i></a>
            </div>
          {{/ifSupportEmail}}

          {{#ifMoreThanOneCampus}}
            <div id="select-campus-mini" class="btn-group sort-by">
              {{selectedCampusButton}}
              <ul class="sort-by-dd dropdown-menu" role="menu">
                  <li><a href="javascript:void(0);" data-campusId="" role="option" aria-label="All campuses {{allCampusesSelectedAriaLabel}}">{{allCampusesCheck}} All campuses</a></li>
                  {{#each this}}
                    <li><a href="javascript:void(0);" data-campusId="{{id}}" role="option" aria-label="{{name}} {{thisCampusSelectedAriaLabel}}">{{selectedCampusCheck}} {{name}}</a></li>
                  {{/each}}
              </ul>
            </div>
          {{/ifMoreThanOneCampus}}
        </script> 
       <div id="navbar-user-menu"> 
        <button id="user-login" class="not-logged-in btn-navbar-login" type="button" tabindex="0" aria-label="Click to login.">Login</button> 
       </div> 
      </div> 
     </div> 
    </div> 
   </div>
  </nav> 
  <div id="campus-landing-wrapper" tabindex="-1"> 
   <div class="container"> 
    <div id="campus-mainToolbar" class="clearfix"> 
     <div class="left" style="padding:0px 0px 0px 20px;width:100%;"> 
      <div id="campus-mainToolbar-links" class="campusvibe-custom-layout"> 
       <div class="navbar navbar-default navbar-fixed-top campusvibe-navbar campusvibe-navbar-live" role="navigation" style="display:none;"> 
        <div class="container"> 
         <div class="campusvibe-navbar-contents"> 
          <ul class="nav navbar-nav navbar-right campusvibe-navbar-responsive"> 
           <li> <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown">More <b class="caret"></b></a> 
            <ul class="dropdown-menu multi-level campusvibe-navbar-responsive-top-level"> 
             <!-- More --> 
            </ul> </li> 
          </ul> 
          <ul class="nav navbar-nav campusvibe-navbar-main" role="menubar"> 
           <li><a href="/campusvibe/campus/b3dec320-64b6-413d-bb5e-dcd3afa78737" role="menuitem" aria-label="Click to return to the home page.">Home</a></li> 
           <li> <a href="javascript:void(0);" class="dropdown-toggle dropdown-top-level" data-toggle="dropdown" role="menu" aria-label="Events menu tab.">Events <b class="caret"></b></a> 
            <ul class="dropdown-menu multi-level"> 
             <li><a href="/campusvibe/events/b3dec320-64b6-413d-bb5e-dcd3afa78737#hub=dee52121-ef80-45ee-aa3f-9e2f1a86b00f" role="menuitem" aria-label="Club Events option in the Events menu tab.">Club Events</a></li> 
             <li><a href="/campusvibe/events/b3dec320-64b6-413d-bb5e-dcd3afa78737#hub=9e80e5c2-96f2-4705-9faf-9ecb8c5227a5" role="menuitem" aria-label="Society Events option in the Events menu tab.">Society Events</a></li> 
             <li><a href="/campusvibe/events/b3dec320-64b6-413d-bb5e-dcd3afa78737" role="menuitem" aria-label="All Events option in the Events menu tab.">All Events</a></li> 
            </ul> </li> 
           <li> <a href="javascript:void(0);" class="dropdown-toggle dropdown-top-level" data-toggle="dropdown" role="menu" aria-label="Clubs &amp; Societies menu tab.">Clubs &amp; Societies <b class="caret"></b></a> 
            <ul class="dropdown-menu multi-level"> 
             <li><a href="/campusvibe/groups/b3dec320-64b6-413d-bb5e-dcd3afa78737#hub=dee52121-ef80-45ee-aa3f-9e2f1a86b00f" role="menuitem" aria-label="Clubs option in the Clubs &amp; Societies menu tab.">Clubs</a></li> 
             <li><a href="/campusvibe/groups/b3dec320-64b6-413d-bb5e-dcd3afa78737#hub=9e80e5c2-96f2-4705-9faf-9ecb8c5227a5" role="menuitem" aria-label="Academic Societies option in the Clubs &amp; Societies menu tab.">Academic Societies</a></li> 
             <li><a href="/campusvibe/groups/b3dec320-64b6-413d-bb5e-dcd3afa78737" role="menuitem" aria-label="All Student Groups option in the Clubs &amp; Societies menu tab.">All Student Groups</a></li> 
            </ul> </li> 
           <li> <a href="javascript:void(0);" class="dropdown-toggle dropdown-top-level" data-toggle="dropdown" role="menu" aria-label="UWSA Services menu tab.">UWSA Services <b class="caret"></b></a> 
            <ul class="dropdown-menu multi-level"> 
             <li><a href="/campusvibe/group/b3dec320-64b6-413d-bb5e-dcd3afa78737/c36da9da-5302-4b1d-abba-b5d45612d590" role="menuitem" aria-label="AfroFest option in the UWSA Services menu tab.">AfroFest</a></li> 
             <li><a href="/campusvibe/group/b3dec320-64b6-413d-bb5e-dcd3afa78737/b4ef0904-822f-406a-b6e0-6d860e642641" role="menuitem" aria-label="Campus Pride Centre option in the UWSA Services menu tab.">Campus Pride Centre</a></li> 
             <li><a href="/campusvibe/group/b3dec320-64b6-413d-bb5e-dcd3afa78737/851b76bc-030e-4454-9672-0980acd98bd4" role="menuitem" aria-label="Shinerama option in the UWSA Services menu tab.">Shinerama</a></li> 
             <li><a href="/campusvibe/groups/b3dec320-64b6-413d-bb5e-dcd3afa78737#policygroup=38567eaa-ead0-4158-a4a7-ca665b03eec1" role="menuitem" aria-label="All Student Services option in the UWSA Services menu tab.">All Student Services</a></li> 
            </ul> </li> 
           <li> <a href="javascript:void(0);" class="dropdown-toggle dropdown-top-level" data-toggle="dropdown" role="menu" aria-label="Forums menu tab.">Forums <b class="caret"></b></a> 
            <ul class="dropdown-menu multi-level"> 
             <li><a href="/campusvibe/feeds/b3dec320-64b6-413d-bb5e-dcd3afa78737" role="menuitem" aria-label="My Timeline option in the Forums menu tab.">My Timeline</a></li> 
             <li><a href="/campusvibe/feeds/b3dec320-64b6-413d-bb5e-dcd3afa78737?feedId=2350b01b-fce4-4150-963f-05fa5ffd2d2b" class="not-logged-in" role="menuitem" aria-label="Club &amp; Society Forum option in the Forums menu tab.">Club &amp; Society Forum</a></li> 
            </ul> </li> 
           <li> <a href="javascript:void(0);" class="dropdown-toggle dropdown-top-level" data-toggle="dropdown" role="menu" aria-label="Forms menu tab.">Forms <b class="caret"></b></a> 
            <ul class="dropdown-menu multi-level"> 
             <li><a href="/campusvibe/publicforms/b3dec320-64b6-413d-bb5e-dcd3afa78737" class="not-logged-in" role="menuitem" aria-label="Forms option in the Forms menu tab.">Forms</a></li> 
             <li><a href="http://www.uwsa.ca/wp-content/uploads/2018/09/UWSA-Student-Group-Handbook-New.pdf" target="_blank" role="menuitem" aria-label="Groups Handbook option in the Forms menu tab.">Groups Handbook</a></li> 
            </ul> </li> 
           <li> <a href="/campusvibe/service-page/b3dec320-64b6-413d-bb5e-dcd3afa78737?servicepageid=59ee7394-8e27-4eb6-874f-6fe838134f5e" role="menuitem" aria-label="HUB HELP Page menu tab.">HUB HELP Page</a> </li> 
           <li> <a href="javascript:void(0);" class="dropdown-toggle dropdown-top-level" data-toggle="dropdown" role="menu" aria-label="Quicklinks menu tab.">Quicklinks <b class="caret"></b></a> 
            <ul class="dropdown-menu multi-level"> 
             <li><a href="http://www.uwsa.ca/" target="_blank" role="menuitem" aria-label="UWSA Website option in the Quicklinks menu tab.">UWSA Website</a></li> 
             <li><a href="http://www.uwindsor.ca/" target="_blank" role="menuitem" aria-label="U Windsor Website option in the Quicklinks menu tab.">U Windsor Website</a></li> 
             <li><a href="https://blackboard.uwindsor.ca/" target="_blank" role="menuitem" aria-label="Blackboard option in the Quicklinks menu tab.">Blackboard</a></li> 
             <li><a href="https://my.uwindsor.ca/" target="_blank" role="menuitem" aria-label="myUWindsor option in the Quicklinks menu tab.">myUWindsor</a></li> 
            </ul> </li> 
          </ul> 
         </div> 
        </div> 
       </div> 
      </div> 
     </div> 
    </div> 
    <div id="campus-jumbotron" class="campus-landing-carousel"> 
     <div class="container"> 
      <div id="carousel-events"> 
       <div class="carr-slide left" data-content="event" data-init="false" style="background:url('/campusvibe/img/event-banner-default.jpg') center bottom;"> 
        <div class="carr-slide-img new"></div> 
        <div class="carr-slide-container"> 
         <div class="carr-slide-data"> 
          <p>Discover Events &amp; Groups</p> 
         </div> 
        </div> 
       </div> 
       <div class="carr-slide middle" data-content="group" data-init="false" style="background:url('/campusvibe/img/event-banner-default.jpg') center bottom;"> 
        <div class="carr-slide-img new"></div> 
        <div class="carr-slide-container"> 
         <div class="carr-slide-data"> 
          <p>Join a Group, Participate</p> 
         </div> 
        </div> 
       </div> 
       <div class="carr-slide right" data-content="feed" data-init="false" style="background:url('/campusvibe/img/event-banner-default.jpg') center bottom;"> 
        <div class="carr-slide-img new"></div> 
        <div class="carr-slide-container"> 
         <div class="carr-slide-data"> 
          <p>Get Involved</p> 
         </div> 
        </div> 
       </div> 
       <div id="carr-progressbar"></div> 
      </div> 
     </div> 
    </div> 
    <!-- / #campus-jumbotron --> 
    <div id="cl-landing-content-wrapper" class="clearfix"> 
     <div class="container"> 
      <div id="events-container" class="col-container clearfix"> 
       <div class="list-item-header clearfix"> 
        <div class="left" style="min-width:230px;"> 
         <h3>Events</h3> 
        </div> 
        <div class="right list-item-header-right"> 
         <button onclick="location.href='/campusvibe/events/b3dec320-64b6-413d-bb5e-dcd3afa78737'" class="flat-button vibrant-blue" type="button" tabindex="0" aria-label="Click to navigate to the Events section and view all events."><span>See all</span></button> 
         <div id="campus-search-events" class="campus-search-wrapper right"> 
          <p class="fieldset"> <input type="text" name="searchEvents" class="col-search-input dropdown-toggle" placeholder="Search events" autocomplete spellcheck="false" autocorrect="off" aria-label="Search events; type partial text and use down arrow to find matches, then press enter on your selection. VoiceOver users should note that using the arrow up and arrow down keys, the screen reader will be reading the event title of the selection you just left (not the selection you are on)."> </p> 
         </div> 
        </div> 
       </div> 
       <div id="events-dropdown-wrapper" class="input-dropdown"> 
        <div class="input-dropdown-container"> 
         <script id="campus-events-dd-template" type="text/x-handlebars-template">
                  <ul class="dropdown-menu" role="menu">
                    <li><a href="/campusvibe/events/b3dec320-64b6-413d-bb5e-dcd3afa78737" data-eventDateRange="week">This week at {{shortName}}</a></li>
                    <li><a href="/campusvibe/events/b3dec320-64b6-413d-bb5e-dcd3afa78737" data-eventDateRange="weekend">This week-end at {{shortName}}</a></li>
                    <li><a href="/campusvibe/events/b3dec320-64b6-413d-bb5e-dcd3afa78737" data-eventDateRange="nextWeek">Next week at {{shortName}}</a></li>
                  </ul>
                </script> 
        </div> 
       </div> 
       <ul id="events-list" class="content-list clearfix"> 
        <script id="events-list-template" type="text/x-handlebars-template">
                {{#each this}}
                  <li>
                    {{#ifFacebookImportedEvent}}
                      <span class="facebook-imported-label" data-toggle="tooltip" data-placement="top" title="Imported from Facebook"><i class="icon-facebook-circled primaryColorForced"></i></span>
                    {{else}}
                      {{#ifShowPassImportedEvent}}
                        <span class="showpass-imported-label primaryColorBGForced" data-toggle="tooltip" data-placement="top" title="Imported from Showpass">

                          <svg version="1.1" id="Layer_2" class="showpassIconWhite" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="7.347px" height="8.542px" viewBox="0 0 6.347 7.542" enable-background="new 0 0 6.347 7.542" xml:space="preserve">
                          <path fill="#DF3232" d="M0.841,2.9c0,0,1.123,0.927,3.39-0.098c0.066,0.106,0.128,0.278,0.469,0.206
                            c0.508-0.212,1.114-0.497,1.499-0.631C6.161,2.251,6.067,1.999,6.347,1.781C6.231,1.255,5.721,0.433,5.445,0.172
                            C5.076,0.319,4.902,0.045,4.848,0C4.099,0.223,1.894,1.346,1.009,2.317C1.141,2.54,1.021,2.738,0.841,2.9z"/>
                          <path fill="#991B1E" d="M1.411,4.066L0.986,3.285c0,0,0.781,0.587,2.475,0.045C2.26,4.096,1.411,4.066,1.411,4.066z"/>
                          <path fill="#DF3232" d="M4.243,3.089c0,0-0.789,0.83-4.015,2.037C0.252,5.227,0.27,5.47,0,5.659
                            c0.095,0.763,0.398,1.214,0.806,1.667c0.224-0.098,0.53,0.044,0.55,0.216c0.843-0.054,3.718-1.504,4.027-2.03
                            C5.201,4.802,4.331,3.184,4.243,3.089z"/>
                          </svg>

                        </span>
                      {{/ifShowPassImportedEvent}}
                    {{/ifFacebookImportedEvent}}
                    {{#ifImageOrBanner}}
                      <div class="list-item-img" style="background-image:url(https://www.campusvibe.ca/Skeddy/rest/gem/v1/image/{{eventImageOrBanner}}?sname=CampusSchema&apitoken=9a3111648e5176ebc2ac4a1d15c5e8dd95261e8b&size=medium);">
                    {{else}}
                      <div class="list-item-img default" style="background-image:url('/campusvibe/img/gme_thumbDefault.png');">
                    {{/ifImageOrBanner}}
                      <a href="/campusvibe/event-details/b3dec320-64b6-413d-bb5e-dcd3afa78737/{{eventId}}" title="{{name}}" tabindex="-1"></a>
                    </div>
                    <div class="list-item-data">
                      <h4><a href="/campusvibe/event-details/b3dec320-64b6-413d-bb5e-dcd3afa78737/{{eventId}}" class="btn-link" title="{{name}}">{{name}}</a></h4>
                      <p class="list-item-author"><strong>{{eventType}}</strong> by {{organizer_link ownerId}} for <strong>{{whoCanAttend}}</strong></p>
                      <p class="list-item-desc">{{desc-excerpt description}} <a href="javascript:void(0);" title="Read more" aria-label="Read more">[...]</a></p>
                    </div>
                  </li>
                {{/each}}
              </script> 
       </ul> 
      </div> 
      <div id="groups-container" class="col-container clearfix"> 
       <div class="list-item-header clearfix"> 
        <div class="left" style="min-width:230px;"> 
         <h3>Groups</h3> 
        </div> 
        <div class="right list-item-header-right"> 
         <button onclick="location.href='/campusvibe/groups/b3dec320-64b6-413d-bb5e-dcd3afa78737'" class="flat-button vibrant-blue" type="button" aria-label="Click to navigate to the Groups section and view all groups."><span>See all</span></button> 
         <div id="campus-search-groups" class="campus-search-wrapper"> 
          <p class="fieldset"> <input type="text" name="searchGroups" class="col-search-input dropdown-toggle" placeholder="Search groups" autocomplete spellcheck="false" autocorrect="off" aria-label="Search groups; type partial text and use down arrow to find matches, then press enter on your selection. VoiceOver users should note that using the arrow up and arrow down keys, the screen reader will be reading the event title of the selection you just left (not the selection you are on)."> </p> 
         </div> 
        </div> 
       </div> 
       <div id="groups-dropdown-wrapper" class="input-dropdown"> 
        <div class="input-dropdown-container"> 
         <script id="campus-groups-sugg-dd-template" type="text/x-handlebars-template">
                  <ul class="dropdown-menu" role="menu">
                    {{#each this}}
                      <li><a href="/campusvibe/groups/b3dec320-64b6-413d-bb5e-dcd3afa78737#{{groupType}}={{groupTypeEscaped}}">Browse <strong>{{groupName}}</strong> groups</a></li>
                    {{/each}}
                  </ul>
                </script> 
        </div> 
       </div> 
       <ul id="groups-list" class="content-list clearfix"> 
        <script id="groups-list-template" type="text/x-handlebars-template">
                {{#each this}}
                  <li>
                    {{#ifImageId}}
                      <div class="list-item-img" style="background-image:url(https://www.campusvibe.ca/Skeddy/rest/gem/v1/image/{{imageId}}?sname=CampusSchema&apitoken=9a3111648e5176ebc2ac4a1d15c5e8dd95261e8b&size=medium);">
                    {{else}}
                      <div class="list-item-img default" style="background-image:url('/campusvibe/img/gme_thumbDefault.png');">
                    {{/ifImageId}}
                      <a href="/campusvibe/group/b3dec320-64b6-413d-bb5e-dcd3afa78737/{{groupId}}" title="{{name}}" tabindex="-1"></a>
                    </div>
                    <div class="list-item-data">
                      <h4><a href="/campusvibe/group/b3dec320-64b6-413d-bb5e-dcd3afa78737/{{groupId}}" title="{{name}}">{{name}}</a></h4>
                      <p class="list-item-author"><strong>{{groupTypeLabel groupType}}</strong> group, <a href="#" title="View {{programType}} program">{{programType}}</a></p>
                      <p class="list-item-desc">{{desc-excerpt description}} <a href="javascript:void(0);" title="Read more" aria-label="Read more">[...]</a></p>
                    </div>
                  </li>
                {{/each}}
              </script> 
       </ul> 
      </div> 
      <div id="groups-feed"> 
       <div id="feed-container" class="groups-col"> 
        <div class="list-item-header clearfix"> 
         <div class="left"> 
          <h3>Campus feed</h3> 
         </div> 
         <div class="right"> 
          <button onclick="location.href='/campusvibe/feeds/b3dec320-64b6-413d-bb5e-dcd3afa78737'" class="flat-button vibrant-blue" type="button" aria-label="Click to navigate to the Feeds section and view all feeds."><span>See all</span></button> 
         </div> 
         <script id="group-feed-col-header" type="text/x-handlebars-template">
                    {{#ifHasFeed}}
                      <!--
                      <div class="right">
                        <button id="group_seeAllFeeds" class="flat-button vibrant-blue" type="button"><i class="icon-right-open"></i> <span>See all feeds</span></button>
                      </div>
                      -->
                    {{/ifHasFeed}}
                  </script> 
        </div> 
        <script id="group-no-feed-posts-message-template" type="text/x-handlebars-template">
                  <div id="group-upcoming-events-message">
                    <div id="group-upcoming-events-message-content">
                                              <div><i class="fa fa-ban secondaryColor" style="font-size:52px;margin-top:20px;"></i></div>
                        <h4>Sorry</h4>
                        <p style="margin-bottom:20px;">You are not authorized to view this content.</p>
                                          </div>
                  </div>
                </script> 
        <script id="group-feeds-preview-template" type="text/x-handlebars-template">

                  {{#each this}}

                    <div class="feed-item clearfix {{reportedClass}}" data-feedPostId="{{feedPostId}}" data-userId="{{userId}}">

                      {{#ifFeedpostIsPoll}}

                        <div class="my-feed-icon mini-feed-icon" style="">
                          <i class="icon-chart-bar-1 primaryColorForced"></i>
                        </div>                      

                      {{else}}

                        {{#ifMemberImage}}
                          <div class="feed-item-img" style="background-image:url('https://www.campusvibe.ca/Skeddy/rest/gem/v1/image/{{this.userImageId}}?sname=CampusSchema&apitoken=9a3111648e5176ebc2ac4a1d15c5e8dd95261e8b&size=medium');">
                            <span class="feed-user-blocked-label" {{#ifIsUserIsBlocked}}style="display:inline-block;opacity:1;"{{else}}style="display:none;opacity:0;"{{/ifIsUserIsBlocked}} data-toggle="tooltip" data-placement="top" title="Blocked"><i class="fa fa-ban"></i></span>
                          </div>
                        {{else}}
                          <div class="feed-item-img" style="background-image:url('/campusvibe/img/avatar-default.png');">
                            <span class="feed-user-blocked-label" {{#ifIsUserIsBlocked}}style="display:inline-block;opacity:1;"{{else}}style="display:none;opacity:0;"{{/ifIsUserIsBlocked}} data-toggle="tooltip" data-placement="top" title="Blocked"><i class="fa fa-ban"></i></span>
                          </div>
                        {{/ifMemberImage}}

                      {{/ifFeedpostIsPoll}}

                      <div class="feed-item-data">

                        <div class="feed-item-data-header clearfix">
                          <p class="left">

                            {{#ifFeedpostIsPoll}}

                              <span class="feed-channel-name">{{picto}} 
                                {{#ifGroupFeed}}
                                  <a href="/campusvibe/group-feeds/b3dec320-64b6-413d-bb5e-dcd3afa78737/{{feedGroupId}}" target="_blank" title="See more in {{this.feedName}}" aria-label="See more in {{this.feedName}}">{{this.feedName}}</a>
                                {{else}}
                                  <a href="/campusvibe/feeds/b3dec320-64b6-413d-bb5e-dcd3afa78737?feedId={{feedId}}" title="See more in {{this.feedName}}" aria-label="See more in {{this.feedName}}">{{this.feedName}}</a>
                                {{/ifGroupFeed}}
                              </span>

                            {{else}}

                              <a href="javascript:void(0);" class="feed-author-name event-author {{openMode}}" data-memberId="{{userId}}" aria-label="{{userFeedLinkAriaLabel}}">{{userName}}</a> 
                              &bull; 
                              <span class="feed-channel-name"> 
                                {{#ifGroupFeed}}
                                  <a href="/campusvibe/group-feeds/b3dec320-64b6-413d-bb5e-dcd3afa78737/{{feedGroupId}}" target="_blank" data-toggle="tooltip" data-placement="top" title="" aria-label="See more">{{pictoOrCircle}}</a>
                                {{else}}
                                  <a href="/campusvibe/feeds/b3dec320-64b6-413d-bb5e-dcd3afa78737?feedId={{feedId}}" data-toggle="tooltip" data-placement="top" title="{{this.feedName}}" aria-label="See more in {{this.feedName}}">{{pictoOrCircle}}</a>
                                {{/ifGroupFeed}}
                              </span>

                            {{/ifFeedpostIsPoll}}

                          </p>

                          <div class="feed-options-right">

                            <div class="feed-options-right-container">

                              <p class="left"><i class="icon-clock"></i> <a href="{{feedpostPermalink}}" class="timeago feed-short-timestamp" title="{{dateCreated}}" aria-label="Last post {{dateCreated}}">{{dateCreated}}</a></p>

                              
                            </div>

                          </div>

                        </div>

                        <div class="feed-item-data-content">

                          {{#ifFeedpostIsPoll}}

                            {{#ifGroupFeed}}

                              <a href="/campusvibe/group-feeds/b3dec320-64b6-413d-bb5e-dcd3afa78737/{{feedGroupId}}#feedpostid={{feedPostId}}" class="flat-button withRightArrow">See poll <i class="icon-right-open-1 primaryColor"></i></a>

                            {{else}}

                              <a href="/campusvibe/feeds/b3dec320-64b6-413d-bb5e-dcd3afa78737#feedpostid={{feedPostId}}" class="flat-button withRightArrow">See poll <i class="icon-right-open-1 primaryColor"></i></a>

                            {{/ifGroupFeed}}

                          {{else}}

                            {{feedTextNoGifsPreview}}

                          {{/ifFeedpostIsPoll}}

                        </div>

                        <p class="feed-item-metadata">
                                                        <span class="feed-like-button disabledLikeBtn"><i class="icon-thumbs-up"></i> <span>{{likes}} {{likeNumString}}</span></span>
                                                  </p>

                      </div>

                    </div>

                  {{/each}}

                </script> 
        <div id="group-feeds-preview-container"></div> 
       </div> 
      </div> 
     </div> 
    </div> 
    <!-- / #cl-landing-content-wrapper --> 
   </div> 
   <!-- / .container --> 
  </div> 
  <!-- / #campus-landing-wrapper --> 
  <div id="user-menu-wrapper" class="hiddenMenu1"> 
   <div id="user-menu-triangle"></div> 
   <div id="user-menu-container"> 
    <div id="user-menu-header" class="user-menu-block clearfix"> 
     <script id="user-menu-photo" type="text/x-handlebars-template">
          {{#ifUserImage}}
            <div id="user-menu-user-photo" class="left" style="background-image:url('https://www.campusvibe.ca/Skeddy/rest/gem/v1/image/{{image}}?sname=CampusSchema&apitoken=9a3111648e5176ebc2ac4a1d15c5e8dd95261e8b&size=small');"></div>
          {{else}}
            <div id="user-menu-user-photo" class="left" style="background-image:url('/campusvibe/img/avatar-default.png');"></div>
          {{/ifUserImage}}
        </script> 
     <div id="user-menu-user-info" class="left"> 
      <script id="user-menu-user-info-template" type="text/x-handlebars-template">
            <span class="user-name">{{userName}}</span>
            <span class="user-title">{{userType}}</span>
          </script> 
     </div> 
     <button tabindex="0" id="user-menu-edit-profile" type="button" onclick="location.href='/campusvibe/my-profile/b3dec320-64b6-413d-bb5e-dcd3afa78737'" data-trigger="hover" class="flat-button medium-small vibrant-blue clear-field-button left" aria-label="Edit my profile"><i class="fa fa-pencil"></i></button> 
    </div> 
    <ul class="navbar-user-menu-options-list"> 
     <li><a href="/campusvibe/my-events/b3dec320-64b6-413d-bb5e-dcd3afa78737" tabindex="0"><i class="icon-calendar"></i> My events</a></li> 
     <li><a href="/campusvibe/my-groups/b3dec320-64b6-413d-bb5e-dcd3afa78737" tabindex="0"><i class="icon-users"></i> My groups</a></li> 
     <li><a href="/campusvibe/my-feeds/b3dec320-64b6-413d-bb5e-dcd3afa78737" tabindex="0"><i class="icon-comment"></i> My feeds</a></li> 
    </ul> 
    <ul class="navbar-user-menu-options-list"> 
     <li><a href="/campusvibe/my-profile/b3dec320-64b6-413d-bb5e-dcd3afa78737" tabindex="0"><i class="icon-user"></i> My profile</a></li> 
    </ul> 
    <ul id="user-menu-signout-option" class="navbar-user-menu-options-list"> 
     <li><a href="javascript:void(0);" class="user-logout" tabindex="0"><i class="fa fa-power-off"></i> Log out</a></li> 
    </ul> 
   </div> 
  </div> 
  <!-- Root element of PhotoSwipe. Must have class pswp. --> 
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"> 
   <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). --> 
   <div class="pswp__bg"></div> 
   <!-- Slides wrapper with overflow:hidden. --> 
   <div class="pswp__scroll-wrap"> 
    <!-- Container that holds slides. 
              PhotoSwipe keeps only 3 of them in the DOM to save memory.
              Don't modify these 3 pswp__item elements, data is added later on. --> 
    <div class="pswp__container"> 
     <div class="pswp__item"></div> 
     <div class="pswp__item"></div> 
     <div class="pswp__item"></div> 
    </div> 
    <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. --> 
    <div class="pswp__ui pswp__ui--hidden"> 
     <div class="pswp__top-bar"> 
      <!--  Controls are self-explanatory. Order can be changed. --> 
      <div class="pswp__counter"></div> 
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button> 
      <button class="pswp__button pswp__button--share" title="Share"></button> 
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> 
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button> 
      <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR --> 
      <!-- element will get class pswp__preloader--active when preloader is running --> 
      <div class="pswp__preloader"> 
       <div class="pswp__preloader__icn"> 
        <div class="pswp__preloader__cut"> 
         <div class="pswp__preloader__donut"></div> 
        </div> 
       </div> 
      </div> 
     </div> 
     <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"> 
      <div class="pswp__share-tooltip"></div> 
     </div> 
     <button class="pswp__button pswp__button--arrow--left" title=""> </button> 
     <button class="pswp__button pswp__button--arrow--right" title=""> </button> 
     <div class="pswp__caption"> 
      <div class="pswp__caption__center"></div> 
     </div> 
    </div> 
   </div> 
  </div> 
  <noscript> 
   <div id="noscript-wrapper" class="centerFlex"> 
    <div id="noscript-container"> 
     <div class="centerFlex"> 
      <i class="fa fa-frown-o primaryColor"></i> 
      <h3>Javascript is disabled</h3> 
      <p>This website relies on Javascript to render its amazing content.<br> Please <strong>enable your browser's Javascript</strong> and <a class="primaryColor" href="/campusvibe/campus/b3dec320-64b6-413d-bb5e-dcd3afa78737">refresh the page</a>. We promise you won't be dissapointed.</p> 
     </div> 
    </div> 
   </div> 
  </noscript> 
  <footer class="clearfix"> 
   <div class="container"> 
    <div id="footer-copyright"> 
     <p>Powered by CampusVibe™ • <a href="/campusvibe/privacy-policy" target="_blank">Privacy policy</a> • <a href="/campusvibe/ferpa-compliance-statement" target="_blank">Ferpa</a> • <a href="/campusvibe/terms-of-service" target="_blank">Terms of service</a> • <a href="/campusvibe/site-map/b3dec320-64b6-413d-bb5e-dcd3afa78737/">Site map</a> • <a href="https://www.facebook.com/campusvibe.net/?fref=corp" title="Follow us on Facebook" target="_blank"><i class="fa fa-facebook-square"></i></a> <a href="https://twitter.com/campusvibe1" title="Follow us on Twitter" target="_blank"><i class="fa fa-twitter-square"></i></a> 
      <!-- <a href="javascript:void(0);" title="Follow us on Google+"><i class="fa fa-google-plus-square"></i></a> --> </p> 
    </div> 
   </div> 
  </footer> 
  <!-- / footer -->  
  <!-- /container --> 
  <script src="/campusvibe/js/vendor/bootstrap.min.js"></script> 
  <script src="/campusvibe/js/vendor/jquery.xml2json.js"></script> 
  <script src="/campusvibe/js/vendor/handlebars-v4.0.5.js"></script> 
  <script src="/campusvibe/js/vendor/jquery.transit.min.js"></script> 
  <script src="/campusvibe/js/vendor/moment.min.js"></script> 
  <script src="/campusvibe/js/vendor/moment-timezone.js"></script> 
  <script src="/campusvibe/js/vendor/perfect-scrollbar.jquery.min.js"></script> 
  <script src="/campusvibe/js/vendor/jquery.dotdotdot.min.js"></script> 
  <script src="/campusvibe/js/vendor/jquery.easing.1.3.js"></script> 
  <script src="/campusvibe/js/vendor/jquery.timeago.js"></script> 
  <script src="/campusvibe/js/vendor/js.cookie.js"></script> 
  <script src="/campusvibe/js/vendor/sweetalert.min.js"></script> 
  <script src="/campusvibe/js/vendor/transit.js"></script> 
  <script src="/campusvibe/js/memberPreview.js"></script> 
  <script src="/campusvibe/js/vendor/photoswipe.min.js"></script> 
  <script src="/campusvibe/js/vendor/photoswipe-ui-default.min.js"></script> 
  <script src="/campusvibe/js/feeds.js"></script> 
  <script src="/campusvibe/js/global_feedslive.js"></script> 
  <script src="/campusvibe/js/main.js.php"></script> 
  <script src="/campusvibe/js/vendor/favico.js"></script> 
  <script src="/campusvibe/js/accessibility.js"></script> 
  <script type="text/javascript">

        var carr_ctn = 0;
        var carr_rand;
        var carr_new_rand;

        var CARR_change_slide_speed, CARR_transition_speed, CARR_slide_length;
        var total_events, total_groups, total_feedposts;

        var EVENTS_query_url, GROUPS_query_url, FEEDPOSTS_query_url;
        var CARR_setInt;
        var CARR_img = [];

        var $CARR_array = [
          {
            "event_img" : "golf_001.jpg",
          },
          {
            "event_img" : "conference-1_001.jpg",
          },
          {
            "event_img" : "picnic_001.jpg",
          },
          {
            "event_img" : "inflatable-fight_001.jpg",
          },
          {
            "event_img" : "catan_001.jpg",
          },
          {
            "event_img" : "casino_001.jpg",
          },
          {
            "event_img" : "baseball_001.jpg",
          },
          {
            "event_img" : "chess_001.jpg",
          },
          {
            "event_img" : "climbing_001.jpg",
          },
          {
            "event_img" : "conference-2_001.jpg",
          },
          {
            "event_img" : "dogs_001.jpg",
          },
          {
            "event_img" : "volleyball_001.jpg",
          }
        ];

        $(function() {

          var CAMPUS_ID = "b3dec320-64b6-413d-bb5e-dcd3afa78737";
          var SLUG = "campus";

          var user_not_signed_in;

          // Get Institution details
                      institution_details_callback(JSON.parse("{\"gemType\":\"gemItem\",\"index\":0,\"id\":\"b3dec320-64b6-413d-bb5e-dcd3afa78737\",\"name\":\"University of Windsor\",\"type\":\"Institution\",\"i\":[{\"k\":\"AccountStatusEnabled\",\"v\":\"false\"},{\"k\":\"AdAstraEnabled\",\"v\":\"false\"},{\"k\":\"AuthenticationType\",\"v\":\"authentication_single_signon_cas\"},{\"k\":\"BaseUrl\",\"v\":\"https:\/\/hub.uwsa.ca\"},{\"k\":\"CountryIso2\",\"v\":null},{\"k\":\"CreateEventDocumentId\",\"v\":\"177c795e-75bb-4343-afc0-fa790d7b341d\"},{\"k\":\"CreateEventInstructions\",\"v\":\"EVENT CREATION INSTRUCTIONS\"},{\"k\":\"CreateGroupDocumentId\",\"v\":null},{\"k\":\"CreateGroupInstructions\",\"v\":\"CLUB CREATION INSTRUCTIONS\"},{\"k\":\"CustomLabelMore\",\"v\":\"Forms \"},{\"k\":\"DefaultUserTypeId\",\"v\":\"labelId_Student\"},{\"k\":\"EmailDomains\",\"v\":\"uwindsor.ca\"},{\"k\":\"FacebookImportEventsEnabled\",\"v\":\"true\"},{\"k\":\"FacebookPage\",\"v\":\"https:\/\/www.facebook.com\/uwsa.uwindsor\/events\"},{\"k\":\"FeedGifsDisabled\",\"v\":\"false\"},{\"k\":\"FormsEnabled\",\"v\":\"true\"},{\"k\":\"ImageId\",\"v\":\"194f8299-e57c-4cd0-afab-7bdee314b4f9\"},{\"k\":\"LayoutId\",\"v\":\"e6ecfaf3-1707-4353-bfc5-9c5445012eff\"},{\"k\":\"LoginPhrase\",\"v\":\"Please login using your UWinID & password\"},{\"k\":\"LoginPhraseFooter\",\"v\":\"\"},{\"k\":\"LoginUsernameFormat\",\"v\":\"Username\"},{\"k\":\"MobileLandingPage\",\"v\":\"mytimeline\"},{\"k\":\"PolicyEventCreation\",\"v\":\"moderated\"},{\"k\":\"PolicyGroupCreation\",\"v\":\"moderated\"},{\"k\":\"PollsEnabled\",\"v\":\"true\"},{\"k\":\"ProductName\",\"v\":\"UWSA Hub\"},{\"k\":\"ScrollFetchEvents\",\"v\":\"20\"},{\"k\":\"ScrollFetchFeedposts\",\"v\":\"20\"},{\"k\":\"ScrollFetchGroups\",\"v\":\"20\"},{\"k\":\"SessionTimeoutSeconds\",\"v\":\"1800\"},{\"k\":\"ShortName\",\"v\":\"UWindsor\"},{\"k\":\"ShowpassImportEventsEnabled\",\"v\":\"false\"},{\"k\":\"ShowpassOrganizerId\",\"v\":\"\"},{\"k\":\"StudentNumberFormat\",\"v\":\"alphanumeric\"},{\"k\":\"StudentNumberLength\",\"v\":\"0\"},{\"k\":\"StudentNumberMandatory\",\"v\":\"false\"},{\"k\":\"StyleName\",\"v\":\"dark-orangeblue\"},{\"k\":\"SupportEmail\",\"v\":\"uwsa@uwindsor.ca\"},{\"k\":\"SupportsMobile\",\"v\":\"false\"},{\"k\":\"SystemMode\",\"v\":\"open\"},{\"k\":\"TimeZone\",\"v\":\"Canada\/Eastern\"},{\"k\":\"UserRenewalBeforeDate\",\"v\":\"2018-11-05T20:29:40.565+0000\"},{\"k\":\"UserRenewalDeadlineDate\",\"v\":\"2018-11-13T20:29:40.568+0000\"},{\"k\":\"UserRenewalStartedDate\",\"v\":\"2018-11-05T20:30:53.580+0000\"},{\"k\":\"UserRenewalState\",\"v\":\"started\"},{\"k\":\"UserRenewalTransactionId\",\"v\":\"244bd754-1957-4aea-9a5f-7fdd7bbcb9be\"},{\"k\":\"MenusEnabled\",\"v\":\"true\"},{\"k\":\"BlockMembershipList\",\"v\":\"false\"},{\"k\":\"FacebookAppId\",\"v\":\"1548265938801936\"},{\"k\":\"GroupCreateButtonDisabled\",\"v\":\"false\"},{\"k\":\"GroupEditDisabled\",\"v\":\"false\"},{\"k\":\"EventCreateButtonDisabled\",\"v\":\"false\"},{\"k\":\"AutoNumeric\",\"v\":\"NorthAmerican\"},{\"k\":\"GrantsPackageEnabled\",\"v\":\"false\"},{\"k\":\"AccountsPackageEnabled\",\"v\":\"false\"},{\"k\":\"ElectionsEnabled\",\"v\":\"false\"},{\"k\":\"HideHometown\",\"v\":\"false\"},{\"k\":\"PaypalLink\",\"v\":null},{\"k\":\"GoogleAnalyticsTrackingId\",\"v\":null},{\"k\":\"DocumentsPackageEnabled\",\"v\":\"false\"},{\"k\":\"EventDocumentFilename\",\"v\":\"UWSA Event Instructions.pdf\"},{\"k\":\"EventDocumentSize\",\"v\":\"136496\"},{\"k\":\"UserRenewalNumberPending\",\"v\":\"0\"},{\"k\":\"UserRenewalNumberDone\",\"v\":\"2037\"},{\"k\":\"UserRenewalDaysActive\",\"v\":\"382\"}],\"c\":[],\"gemProps\":{\"properties\":[]}}"), SLUG, true);
          
          Cookies.set('cv_dev_userToken', USER_TOKEN);

          if(!user_not_signed_in){

            CARR_change_slide_speed = 30000;
            CARR_slide_length = 5000;
            CARR_transition_speed = 1500;

            // 1. Get number of EVENTS / GROUPS / FEEDPOSTS

            var EVENT_LIST_DATEMIN = encodeURIComponent(moment().startOf("day").format('YYYY-MM-DDTHH:mm:ss.SSSZZ'));

            // Get Campus list
            get_campus_list(campus_list_callback);

            get_events_list(events_callback, SLUG, 6, REQ_OFFSET, USER_TOKEN, EVENT_LIST_DATEMIN, false, false, false, "init", "false");
            get_groups_list(groups_callback, SLUG, 6, REQ_OFFSET);

            get_feed_items(feed_items_callback, 'init', SLUG, null, 5, REQ_OFFSET, 0);

            get_type_list(type_list_callback, ["programtype", "category", "grouptype"], SLUG, "groups");

            /*
            $.ajax({
              type : 'GET',
              url : DOMAIN + '/Skeddy/rest/gem/v1/event?sname=CampusSchema&oid='+CAMPUS_ID+'&state=published&apitoken='+USER_TOKEN+'&limit=1',
              dataType : 'json',
              success : function(data){
                console.log("TEST EVENTS :");
                console.log(data);
              }
            });
            */

            // EVENTS

            $('body').on("click", 'button[name="seeHiddenGif"]', function(){
              var $TARGET = $(this);
              var $CONTAINER = $TARGET.parents('div.feed-item-data-content');
              if($TARGET.hasClass("withUpArrow")){
                $CONTAINER.find('img.fp-gif').remove();
                $TARGET.addClass('withDownArrow').removeClass('withUpArrow').text('See gif');
              }else{
                $CONTAINER.append('<img class="fp-gif" src="' + $TARGET.attr("data-animated") + '" data-gifId="' + $TARGET.attr("data-gifId") + '">');
                $TARGET.addClass('withUpArrow').removeClass('withDownArrow').text('Hide gif');
              }
            });

            $.when(
                $.ajax({
                    type : 'GET',
                    url: DOMAIN + '/Skeddy/rest/gem/v1/feed?sname=CampusSchema&apitoken='+USER_TOKEN+'&institutionid='+CAMPUS_ID+'&feedtypeid=MainFeedTypeId',
                    dataType : 'json'
                })
            ).then(function(mainFeedExist){
                return $.ajax({
                    type : 'GET',
                    url: DOMAIN + '/Skeddy/rest/gem/v1/feedpost?sname=CampusSchema&apitoken='+USER_TOKEN+'&limit=1&feedid='+mainFeedExist.listT[0].feedId,
                    dataType : 'json'
                })
            }).then(function(feedpostsExist){

              console.log("RETURN ");
              console.log(feedpostsExist);

              total_feedposts = feedpostsExist.totalAvailable;

              $.when(
                (LOGGED_IN && feedpostsExist.listT[0] && typeof(feedpostsExist.listT[0].userId) != "undefined" && feedpostsExist.listT[0].userId) ? $.ajax({
                  type : 'GET',
                  url : DOMAIN + '/Skeddy/rest/gem/v1/user/'+feedpostsExist.listT[0].userId+'?sname=CampusSchema&apitoken='+USER_TOKEN,
                  dataType : 'json'
                }): $.when(null),
                $.ajax({
                  type : 'GET',
                  url : DOMAIN + '/Skeddy/rest/gem/v1/event?sname=CampusSchema&oid='+CAMPUS_ID+'&state=published&apitoken='+USER_TOKEN+'&limit=1',
                  dataType : 'json'
                }),
                $.ajax({
                    type : 'GET',
                    url: DOMAIN + '/Skeddy/rest/gem/v1/event?sname=CampusSchema&oid='+CAMPUS_ID+'&state=published&apitoken='+USER_TOKEN+'&limit=1&datemin='+EVENT_LIST_DATEMIN,
                    dataType : 'json'
                }),
                $.ajax({
                    type : 'GET',
                    url: DOMAIN + '/Skeddy/rest/gem/v1/group?sname=CampusSchema&oid='+CAMPUS_ID+'&state=published_pendfull_approvedfull_expired_probationary&apitoken='+USER_TOKEN+'&limit=1',
                    dataType : 'json'
                })
              ).done(function(userOBJ, eventsExist, upcomingEventsExist, groupsExist){

                //var event_init, group_init, feedpost_init;

                if(upcomingEventsExist[0].listT[0]){
                  EVENTS_query_url = DOMAIN + '/Skeddy/rest/gem/v1/event?sname=CampusSchema&oid='+CAMPUS_ID+'&state=published&apitoken='+USER_TOKEN+'&datemin='+EVENT_LIST_DATEMIN+'&limit=1';
                  total_events = upcomingEventsExist[0].totalAvailable;
                  var eventImg = (upcomingEventsExist[0].listT[0].imageId) ? upcomingEventsExist[0].listT[0].imageId : (upcomingEventsExist[0].listT[0].bannerId) ? upcomingEventsExist[0].listT[0].bannerId : null;
                  //event_init = {"name" : upcomingEventsExist[0].listT[0].name, "imageId" : eventImg};
                  CARR_img.push({"content" : upcomingEventsExist[0].listT[0].name, "type" : "event", "imageId" : eventImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + eventImg + '?sname=CampusSchema&apitoken='+USER_TOKEN+'&size=large', "default" : "/" + ROOT + "/img/event-banner-default.jpg", "objURL" : "/" + ROOT + "/event-details/"+ CAMPUS_ID + "/" + upcomingEventsExist[0].listT[0].eventId, "position" : "left"});
                }else if(eventsExist[0].listT[0]){
                  EVENTS_query_url = DOMAIN + '/Skeddy/rest/gem/v1/event?sname=CampusSchema&oid='+CAMPUS_ID+'&state=published&apitoken='+USER_TOKEN+'&limit=1';
                  total_events = eventsExist[0].totalAvailable;
                  var eventImg = (eventsExist[0].listT[0].imageId) ? eventsExist[0].listT[0].imageId : (eventsExist[0].listT[0].bannerId) ? eventsExist[0].listT[0].bannerId : null;
                  CARR_img.push({"content" : eventsExist[0].listT[0].name, "type" : "event", "imageId" : eventImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + eventImg + '?sname=CampusSchema&apitoken='+USER_TOKEN+'&size=large', "default" : "/" + ROOT + "/img/event-banner-default.jpg", "objURL" : "/" + ROOT + "/event-details/"+ CAMPUS_ID + "/" + eventsExist[0].listT[0].eventId, "position" : "left"});
                }else{
                  var eventImg = "";
                  CARR_img.push({"content" : "", "type" : "event", "imageId" : eventImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + eventImg + '?sname=CampusSchema&apitoken='+USER_TOKEN, "default" : "/" + ROOT + "/img/event-banner-default.jpg", "objURL" : "", "position" : "left"});
                  $('div.carr-slide[data-content="event"]').attr("data-locked", "true");
                }

                if(groupsExist[0].listT[0]){
                  GROUPS_query_url = DOMAIN + '/Skeddy/rest/gem/v1/group?sname=CampusSchema&oid='+CAMPUS_ID+'&state=published_pendfull_approvedfull_expired_probationary&apitoken='+USER_TOKEN+'&limit=1';
                  total_groups = groupsExist[0].totalAvailable;
                  var groupImg = (groupsExist[0].listT[0].imageId) ? groupsExist[0].listT[0].imageId : (groupsExist[0].listT[0].bannerImageId) ? groupsExist[0].listT[0].bannerImageId : null;
                  CARR_img.push({"content" : groupsExist[0].listT[0].name, "type" : "group", "imageId" : groupImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + groupImg + '?sname=CampusSchema&apitoken='+USER_TOKEN+'&size=large', "default" : "/" + ROOT + "/img/event-banner-default.jpg", "objURL" : "/" + ROOT + "/group/"+ CAMPUS_ID + "/" + groupsExist[0].listT[0].groupId, "position" : "middle"});
                }else{
                  var groupImg = "";
                  CARR_img.push({"content" : "", "type" : "group", "imageId" : groupImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + groupImg + '?sname=CampusSchema&apitoken='+USER_TOKEN+'&size=large', "default" : "/" + ROOT + "/img/event-banner-default.jpg", "objURL" : "", "position" : "middle"});
                  $('div.carr-slide[data-content="group"]').attr("data-locked", "true");
                }

                if(userOBJ){
                  FEEDPOSTS_query_url = DOMAIN + '/Skeddy/rest/gem/v1/feedpost?sname=CampusSchema&apitoken='+USER_TOKEN+'&limit=1&feedid='+feedpostsExist.listT[0].feedId;
                  var userImg = parse_OBJ(userOBJ[0].i, "ImageId");
                  CARR_img.push({"content" : "<p><i class='icon-quote flip'></i> " + stripHTML(feedpostsExist.listT[0].text).trunc(25) + ' <i class="icon-quote"></i></p> <div class="carr-feedpost-author">By '+ returnPlainHTML(parse_OBJ(userOBJ[0].i, "firstName")) +' '+ returnPlainHTML(parse_OBJ(userOBJ[0].i, "lastName")) +'</div>', "type" : "feed", "imageId" : userImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + userImg + '?sname=CampusSchema&apitoken='+USER_TOKEN+'&size=large', "default" : "/" + ROOT + "/img/avatar-default.png", "position" : "right"});  
                }else if(!LOGGED_IN || INSTITUTION_SYS_MODE == "open"){
                  FEEDPOSTS_query_url = DOMAIN + '/Skeddy/rest/gem/v1/feedpost/mytimeline?sname=CampusSchema&apitoken='+USER_TOKEN+'&limit=1&previewcomments=0';
                  var userImg = '';
                  CARR_img.push({"content" : "<p><i class='icon-quote flip'></i> " + stripHTML(feedpostsExist.listT[0].text).trunc(25) + ' <i class="icon-quote"></i></p> <div class="carr-feedpost-author">By user</div>', "type" : "feed", "imageId" : userImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + userImg + '?sname=CampusSchema&apitoken='+USER_TOKEN+'&size=large', "default" : "/" + ROOT + "/img/avatar-default.png", "position" : "right"});  
                }else{
                  var userImg = '';
                  CARR_img.push({"content" : "", "type" : "feed", "imageId" : userImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + userImg + '?sname=CampusSchema&apitoken='+USER_TOKEN+'&size=large', "default" : "/" + ROOT + "/img/avatar-default.png", "position" : "right"});  
                  $('div.carr-slide[data-content="feed"]').attr("data-locked", "true");
                }

                var preloadImg = [];

                $.each(CARR_img, function(index, value){
                  (value.imageId && value.imageId != '') ? preloadImg.push(value.url) : preloadImg.push(value.default);
                });

                preloadPictures(preloadImg, function(){
                  console.log('ALL PRELOADED');
                  setTimeout( function(){ $("div.carr-slide:not([data-locked]").attr("style", ""); }, 500);
                  $("div.carr-slide > div.carr-slide-container").fadeOut("slow").remove();
                  $('div.carr-slide').attr("data-init", "true");
                  CARR_displayNewSlides();
                });

              });

            });

            $("div#carousel-events").on({
              mouseenter: function () {
                $(this).find(".carr-slide-img-container").animate({"opacity" : "0.8"}, "fast");
              },
              mouseleave: function () {
                $(this).find(".carr-slide-img-container").animate({"opacity" : "1"}, "fast");
              }
            }, ".carr-slide");

          }

        });

        function CARR__getNewCarSlide(){

          var rand_event = randomIntFromInterval(0, (total_events-1));
          var rand_group = randomIntFromInterval(0, (total_groups-1));
          var rand_feedpost = randomIntFromInterval(0, (total_feedposts-1));

          $("#carr-progressbar").fadeOut(CARR_transition_speed, function(){
            $(this).css("width", "0%").show();
          });

          $.when(
              (!$('div.carr-slide[data-content="feed"]').attr("data-locked")) ? $.ajax({
                  type : 'GET',
                  url: FEEDPOSTS_query_url+'&offset='+rand_feedpost,
                  dataType : 'json'
              }): $.when(null)
          ).then(function(feedpostOBJ){

            $.when(
              (feedpostOBJ && typeof(feedpostOBJ.listT[0].userId) != "undefined" && feedpostOBJ.listT[0].userId) ? $.ajax({
                type : 'GET',
                url : DOMAIN + '/Skeddy/rest/gem/v1/user/'+feedpostOBJ.listT[0].userId+'?sname=CampusSchema&apitoken='+USER_TOKEN,
                dataType : 'json'
              }): $.when(null),
              (!$('div.carr-slide[data-content="event"]').attr("data-locked")) ? $.ajax({
                type : 'GET',
                url : EVENTS_query_url+'&offset='+rand_event,
                dataType : 'json'
              }) : $.when(null),
              (!$('div.carr-slide[data-content="group"]').attr("data-locked")) ? $.ajax({
                  type : 'GET',
                  url: GROUPS_query_url+'&offset='+rand_group,
                  dataType : 'json'
              }) : $.when(null)
            ).done(function(userOBJ, eventOBJ, groupOBJ){

              if(eventOBJ != null && typeof(eventOBJ[0].listT) != "undefined"){
                var eventImg = (eventOBJ[0].listT[0].imageId) ? eventOBJ[0].listT[0].imageId : (eventOBJ[0].listT[0].bannerId) ? eventOBJ[0].listT[0].bannerId : null;
                CARR_img.push({"content" : eventOBJ[0].listT[0].name, "type" : "event", "imageId" : eventImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + eventImg + '?sname=CampusSchema&apitoken='+USER_TOKEN+'&size=large', "default" : "/" + ROOT + "/img/event-banner-default.jpg", "objURL" : "/" + ROOT + "/event-details/"+ CAMPUS_ID + "/" + eventOBJ[0].listT[0].eventId, "position" : "left"});                
              }

              if(groupOBJ != null && typeof(groupOBJ[0].listT) != "undefined"){
                var groupImg = (groupOBJ[0].listT[0].imageId) ? groupOBJ[0].listT[0].imageId : (groupOBJ[0].listT[0].bannerImageId) ? groupOBJ[0].listT[0].bannerImageId : null;
                CARR_img.push({"content" : groupOBJ[0].listT[0].name, "type" : "group", "imageId" : groupImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + groupImg + '?sname=CampusSchema&apitoken='+USER_TOKEN+'&size=large', "default" : "/" + ROOT + "/img/event-banner-default.jpg", "objURL" : "/" + ROOT + "/group/"+ CAMPUS_ID + "/" + groupOBJ[0].listT[0].groupId, "position" : "middle"});            
              }

              if(userOBJ){
                var userImg = parse_OBJ(userOBJ[0].i, "ImageId");
                CARR_img.push({"content" : "<p><i class='icon-quote flip'></i> " + stripHTML(feedpostOBJ.listT[0].text).trunc(25) + ' <i class="icon-quote"></i></p> <div class="carr-feedpost-author">By '+ returnPlainHTML(parse_OBJ(userOBJ[0].i, "firstName")) +' '+ returnPlainHTML(parse_OBJ(userOBJ[0].i, "lastName")) +'</div>', "type" : "feed", "imageId" : userImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + userImg + '?sname=CampusSchema&apitoken='+USER_TOKEN+'&size=large', "default" : "/" + ROOT + "/img/avatar-default.png", "position" : "right"});          
              }else{
                var userImg = '';
                CARR_img.push({"content" : "<p><i class='icon-quote flip'></i> " + stripHTML(feedpostOBJ.listT[0].text).trunc(25) + ' <i class="icon-quote"></i></p> <div class="carr-feedpost-author">By user</div>', "type" : "feed", "imageId" : userImg, "url" : DOMAIN + '/Skeddy/rest/gem/v1/image/' + userImg + '?sname=CampusSchema&apitoken='+USER_TOKEN+'&size=large', "default" : "/" + ROOT + "/img/avatar-default.png", "position" : "right"});                    
              }

              var preloadImg = [];

              $.each(CARR_img, function(index, value){
                (value.imageId && value.imageId != '') ? preloadImg.push(value.url) : preloadImg.push(value.default);
              });

              preloadPictures(preloadImg, function(){
                  console.log('ALL PRELOADED');
                  CARR_displayNewSlides();
              });

            });

          });

        }

        function CARR_displayNewSlides(){
          var slideContent, isFeed, objURL;

          console.log("CARR_img :");
          console.log(CARR_img);

          $.each(CARR_img, function(index, value){
            slideContent = (value.type == "feed") ? value.content : '<p>' + value.content.trunc(22) + '</p>';
            objURL = (typeof(value.objURL) != "undefined" && value.objURL) ? value.objURL : 'javascript:void(0);';

            if(!$('div.carr-slide[data-content="'+value.type+'"]').attr("data-locked")){
              if(value.imageId && value.imageId != ''){
                $(".carr-slide").filter('.' + value.position).find(".carr-slide-img.new").after('<div class="carr-slide-img queued" style="z-index:100;"><div class="carr-slide-img-container" style="background-image:url(' + value.url + ');"></div><a href="'+objURL+'" class="carr-slide-container queued" tabindex="-1"><div class="carr-slide-data">'+ slideContent +'</div></a></div>');
              }else{
                isFeed = (value.type == "feed") ? "default-feed" : "default";
                $(".carr-slide").filter('.' + value.position).find(".carr-slide-img.new").after('<div class="carr-slide-img queued" style="z-index:100;"><div class="carr-slide-img-container '+ isFeed +'" style="background-image:url(' + value.default + ');"></div><a href="'+objURL+'" class="carr-slide-container queued" tabindex="-1"><div class="carr-slide-data">'+ slideContent +'</div></a></div>');
              }
            }

          });

          // 360

          $("#carousel-events .carr-slide > .carr-slide-img.new").each(function(index, elem){
              $(elem).delay(160 * index).animate({"top" : "-=130px"}, 360, "easeOutBack", function(){ $(this).remove(); });
          });

          $("#carousel-events .carr-slide > .carr-slide-img.queued").each(function(index, elem){
              $(elem).css("top" , "130px").delay(160 * index).animate({"top" : "0px"}, 360, "easeOutBack", function(){ $(this).removeClass("queued").addClass("new"); });
          });

          $("#carr-progressbar").animate({"width" : "100%"}, CARR_change_slide_speed, function(e){
            CARR__getNewCarSlide();
            //CARR_displayNewSlides();
          });

          CARR_img = [];
        }

        /* ********** SEARCH BARS ********** */

        var $COL_SEARCHBARS = $("#cl-landing-content-wrapper input.col-search-input");
        var COL_BAR_POS;
        var sb_w, atc_w;

        if($(window).width() < 1600){
          sb_w = ($("div#events-container .list-item-header").outerWidth());
        }else{
          sb_w = 250;
        }

        console.log("*** sb_w ***");
        console.log(sb_w);

        var $INPUT_EVENTS = $('input[name="searchEvents"]');
        var $INPUT_EVENTS_WRAPPER = $INPUT_EVENTS.parents("div#campus-search-events");

        var $INPUT_GROUPS = $('input[name="searchGroups"]');
        var $INPUT_GROUPS_WRAPPER = $INPUT_GROUPS.parents("div#campus-search-groups");

        var r = [];
        var $INPUT_TARGET;
        var label, labelText;
        var load_spinner;
        var dd_setTimeOut;

        $COL_SEARCHBARS.click(
          function(e){
            if(!$(this).hasClass("search-focus")){
              //COL_BAR_POS = $(this).offset().left - $(this).parents(".col-container").offset().left;
              COL_BAR_POS = 0;
              $(this).animate({"width": sb_w+"px"}, 350).addClass("search-focus");
              $(this).parents(".col-container").find(".input-dropdown").css({"top" : "43px"}).find("ul.dropdown-menu").show().animate({"width" : (sb_w-1)+"px"}, 350);
            }
          }
        );

        $COL_SEARCHBARS.blur(function(e){
          var $par = $(this).parents("div.campus-search-wrapper");
          clearTimeout(dd_setTimeOut);
          $(this).val("").attr("data-init", "");
          $par.find('i.icon-search.input-search-picto').remove();
          $par.find("i.fa-times.cancel-searching").remove();
          $par.find("i.fa-refresh.refresh-searching").remove();
          $par.find("ul.ui-autocomplete").perfectScrollbar("destroy");
          $(this).animate({"width": "35px"}, 350);
          $(this).removeClass("search-focus").parents(".col-container").find("ul.dropdown-menu").css("width","0px").hide();
        });

        /* FOCUS EVENTS / GROUPS SEARCH BAR */

        $INPUT_EVENTS.add($INPUT_GROUPS).on('focus', function(){
          $(this).click();
        });

        /* SEARCH EVENTS */

        var EVENT_LIST_DATEMIN = encodeURIComponent(moment().startOf("day").format('YYYY-MM-DDTHH:mm:ss.SSSZZ'));

        $('input[name="searchEvents"], input[name="searchGroups"]').keyup(function(e){
          var $target = $(this);
          var $par = $target.parents("div.campus-search-wrapper");
          if($(this).attr("data-init") != "loaded"){
            $(this).attr("data-init", "loaded");
          }
          if($(this).val() == ""){
            $par.find("i.fa-refresh.refresh-searching").hide();
            $par.find("i.fa-times.cancel-searching").hide();
            $par.find("ul.ui-autocomplete").perfectScrollbar("destroy");
            dd_setTimeOut = setTimeout(function(){
              if($par.find("ul.ui-autocomplete").css("display") == "none"){
                if($target.attr("name") == "searchEvents"){
                  $("div#events-container ul.dropdown-menu").css("width", (sb_w-1)+"px").show();
                }else if($target.attr("name") == "searchGroups"){
                  $("div#groups-container ul.dropdown-menu").css("width", (sb_w-1)+"px").show();
                }
              }
            }, 200);
          }
        });

        $('input[name="searchEvents"], input[name="searchGroups"]').blur(function(e){
          var $par = $(this).parents("div.campus-search-wrapper");
          if($(this).attr("data-init") && $(this).val() == ""){
            $par.find('i.icon-search.input-search-picto').remove();
            $par.find("i.fa-times.cancel-searching").remove();
            $par.find("i.fa-refresh.refresh-searching").remove();
            $(this).attr("data-init", "");
            $par.find("ul.ui-autocomplete").perfectScrollbar("destroy");
          }
        });

        $("div#events-container").on("click", 'i.fa.fa-times.cancel-searching', function(e){
          $('input[name="searchEvents"]').val("").focus().trigger("keyup");
        });

        $("div#groups-container").on("click", 'i.fa.fa-times.cancel-searching', function(e){
          $('input[name="searchGroups"]').val("").focus().trigger("keyup");
        });

        $('input[name="searchEvents"]').autocomplete({
          source: function( request, response ) {
            $.ajax({
              url : DOMAIN + '/Skeddy/rest/gem/v1/event?institutionid='+CAMPUS_ID+'&sname=CampusSchema&apitoken='+USER_TOKEN+'&state=published_expired&datemin='+EVENT_LIST_DATEMIN,
              dataType: "json",
              data: {
                'name': request.term
              },
              success: function( data ) {
                if(data){
                  if(data.listT.length){
                    r = [];
                    var eventImage, startDate, endDate, dateString;
                    $.each(data.listT, function(index, value){
                      dateString = (moment(value.dateEnd).isAfter(moment(value.date), 'day')) ? "From " + moment(value.date).format("MMMM D") + " to " + moment(value.dateEnd).format("MMMM D") : "On " + moment(value.date).format("MMMM D");
                      eventImage = (value.imageId) ? DOMAIN + "/Skeddy/rest/gem/v1/image/" + value.imageId + "?sname=CampusSchema&apitoken=" + USER_TOKEN+'&size=small' : (value.bannerId) ? DOMAIN + "/Skeddy/rest/gem/v1/image/" + value.bannerId + "?sname=CampusSchema&apitoken=" + USER_TOKEN : '/' + ROOT + '/img/gme_thumbDefault.png';
                      r[index] = "<div data-eventId='" + value.eventId + "' class='clearfix'><div class='ui-search-item-image' style='background-image:url(" + eventImage + " );'></div><div class='ui-search-item-data'><span class='ui-search-item-name'>" + value.name + "</span> <span class='ui-search-event-dates'>" + dateString + "</span></div>";
                    });
                    response(r);
                  }else{
                    r = [];
                    $INPUT_EVENTS.removeClass("ui-corner-top").addClass("ui-corner-all");
                    $INPUT_EVENTS_WRAPPER.find("i.fa-refresh.refresh-searching").remove();
                    $INPUT_EVENTS_WRAPPER.find("i.fa-times.cancel-searching").show();
                    load_spinner = false;
                  }
                }else{
                  r = [];
                  $INPUT_EVENTS.removeClass("ui-corner-top").addClass("ui-corner-all");
                  $INPUT_EVENTS_WRAPPER.find("i.fa-refresh.refresh-searching").remove();
                  $INPUT_EVENTS_WRAPPER.find("i.fa-times.cancel-searching").show();
                  load_spinner = false;
                }
              }
            });
          },
          minLength: 1,
          delay: 0,
          messages: {
              noResults: '',
              results: function() {}
          },
          search : function( event, ui ) {
            if(!load_spinner){
              load_spinner = true;
              $INPUT_EVENTS_WRAPPER.find("i.fa-times.cancel-searching").hide();
              setTimeout(function(){
                $INPUT_EVENTS.parents("p.fieldset").append('<i class="fa fa-refresh refresh-searching fa-spin" title="Loading..." aria-label="Loading"></i>');
              }, 15);
            }
          },
          select: function( event, ui ) {
            event.preventDefault();
            var eventId = $(ui.item.label).attr("data-eventId");
            $INPUT_EVENTS.prop("disabled", true);
            if(eventId) window.location.href = '/'+ ROOT +'/event-details/'+ CAMPUS_ID +'/'+ eventId;
          },
          focus: function( event, ui ) {
            event.preventDefault();
            this.value = $(ui.item.label).find("span.ui-search-item-name").text();
            $('li.ui-menu-item').removeClass("ui-state-focus");
            var menu = $(this).data("ui-autocomplete").menu.element;
            menu.find(".ui-state-active").parent('li').addClass("ui-state-focus");
          },
          open: function(e, ui) {
            $INPUT_TARGET = $(this);
            var $UI_AUTO = $INPUT_EVENTS_WRAPPER.find("ul.ui-autocomplete");
            var $itemName = $INPUT_EVENTS_WRAPPER.find('li .ui-search-item-name');
            var menu = $(this).data("ui-autocomplete").menu.element;
            $("div#events-container ul.dropdown-menu").css("width", "0px").hide();

            $(this).removeClass("ui-corner-all").addClass("ui-corner-top");

            $UI_AUTO.css(
              {
                "height" : "auto",
                "margin-top" : "34px",
                "top" : "0px",
                "left" : "0px"
              }
              ).perfectScrollbar({
                wheelPropagation : true
            });

            clearTimeout(dd_setTimeOut);
            $INPUT_EVENTS_WRAPPER.find("i.fa-refresh.refresh-searching").remove();
            load_spinner = false;

            if($INPUT_EVENTS_WRAPPER.find("i.fa-times.cancel-searching").length){
              $INPUT_EVENTS_WRAPPER.find("i.fa-times.cancel-searching").show();
            }else{
              setTimeout(function(){
                $INPUT_EVENTS.parents("p.fieldset").append('<i class="fa fa-times cancel-searching" title="Cancel search" role="button"></i>');
              }, 15);
            }

          },
          close: function() {
            r = [];
            $( this ).removeClass("ui-corner-top").addClass("ui-corner-all");
            $INPUT_EVENTS_WRAPPER.find("i.fa-refresh.refresh-searching").remove();
            load_spinner = false;
          },
          change: function( event, ui ) {
            if(this.value == ""){
              r = [];
              $INPUT_EVENTS_WRAPPER.find("i.fa-times.cancel-searching").hide();
              $INPUT_EVENTS.autocomplete("close");
            }
          },
          response: function( event, ui ) {
          },
          create: function( event, ui ) {
            $INPUT_EVENTS_WRAPPER.find("ul.ui-autocomplete").addClass("ui-autocomplete-search-items ui-autocomplete-clp");
          },
          appendTo: '#events-container div.list-item-header #campus-search-events'
        }).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
          label = $(item.label);
          labelText = label.find("span.ui-search-item-name").text().replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)(" + $.ui.autocomplete.escapeRegex(this.term) + ")(?![^<>]*>)(?![^&;]+;)", "gi"), "<strong>$1</strong>");
          label.find("span.ui-search-item-name").html(labelText);
          item.label = label.prop('outerHTML');
          return $( "<li></li>" )
          .data( "ui-autocomplete-item", item )
          .append( item.label )
          .appendTo( ul );
        };

        /* GROUPS */

       $('input[name="searchGroups"]').autocomplete({
          source: function( request, response ) {
            $.ajax({
              url : DOMAIN + '/Skeddy/rest/gem/v1/group?institutionid='+CAMPUS_ID+'&sname=CampusSchema&apitoken='+USER_TOKEN+'&state=published_pendfull_approvedfull_expired_probationary',
              dataType: "json",
              data: {
                'name': request.term
              },
              success: function( data ) {
                if(data){
                  if(data.listT.length){
                      r = [];
                      var eventImage, startDate, endDate, memberCountString;
                      $.each(data.listT, function(index, value){
                        memberCountString = (value.memberCount <= 1) ? 'member' : 'members';
                        eventImage = (value.imageId) ? DOMAIN + "/Skeddy/rest/gem/v1/image/" + value.imageId + "?sname=CampusSchema&apitoken=" + USER_TOKEN+'&size=small' : '/' + ROOT + '/img/gme_thumbDefault.png';
                        r[index] = "<div data-groupId='" + value.groupId + "' class='clearfix'><div class='ui-search-item-image' style='background-image:url(" + eventImage + " );'></div><div class='ui-search-item-data'><span class='ui-search-item-name'>" + value.name + "</span> <span class='ui-search-event-dates'>" + value.memberCount + " " + memberCountString + "</span></div>";
                      });
                      response(r);
                  }else{
                    r = [];
                    $INPUT_GROUPS.removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
                    $INPUT_GROUPS_WRAPPER.find("i.fa-refresh.refresh-searching").remove();
                    $INPUT_GROUPS_WRAPPER.find("i.fa-times.cancel-searching").show();
                    load_spinner = false;
                  }
                }else{
                  r = [];
                  $INPUT_GROUPS.removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
                  $INPUT_GROUPS_WRAPPER.find("i.fa-refresh.refresh-searching").remove();
                  $INPUT_GROUPS_WRAPPER.find("i.fa-times.cancel-searching").show();
                  load_spinner = false;
                }
              }
            });
          },
          minLength: 1,
          delay: 0,
          messages: {
              noResults: '',
              results: function() {}
          },
          search : function( event, ui ) {
            if(!load_spinner){
              load_spinner = true;
              $INPUT_GROUPS_WRAPPER.find("i.fa-times.cancel-searching").hide();
              setTimeout(function(){
                $INPUT_GROUPS.parents("p.fieldset").append('<i class="fa fa-refresh refresh-searching fa-spin" title="Loading..." aria-label="Loading"></i>');
              }, 15);
            }
          },
          select: function( event, ui ) {
            event.preventDefault();
            var groupId = $(ui.item.label).attr("data-groupId");
            $INPUT_GROUPS.prop("disabled", true);
            if(groupId) window.location.href = '/'+ ROOT +'/group/'+ CAMPUS_ID +'/'+ groupId;
          },
          focus: function( event, ui ) {
            event.preventDefault();
            this.value = $(ui.item.label).find("span.ui-search-item-name").text();
            $('li.ui-menu-item').removeClass("ui-state-focus");
            var menu = $(this).data("ui-autocomplete").menu.element;
            menu.find(".ui-state-active").parent('li').addClass("ui-state-focus");
          },
          open: function(e, ui) {
            $INPUT_TARGET = $(this);
            var $UI_AUTO = $INPUT_GROUPS_WRAPPER.find("ul.ui-autocomplete");
            var $itemName = $INPUT_GROUPS_WRAPPER.find('li .ui-search-item-name');
            var menu = $(this).data("ui-autocomplete").menu.element;
            $("div#groups-container ul.dropdown-menu").css("width", "0px").hide();

            $(this).removeClass("ui-corner-all").addClass("ui-corner-top");

             $UI_AUTO.css(
              {
                "height" : "auto",
                "margin-top" : "34px",
                "top" : "0px",
                "left" : "0px"
              }
              ).perfectScrollbar({
                wheelPropagation : true
            });

            $INPUT_GROUPS_WRAPPER.find("div.scroll-wrapper").addClass("scrollbar-inner").css({"max-height" : "300px", "width" : (sb_w-1)+"px", "left" : "-" + (sb_w+7)+"px"});

            clearTimeout(dd_setTimeOut);
            $INPUT_GROUPS_WRAPPER.find("i.fa-refresh.refresh-searching").remove();
            load_spinner = false;

            if($INPUT_GROUPS_WRAPPER.find("i.fa-times.cancel-searching").length){
              $INPUT_GROUPS_WRAPPER.find("i.fa-times.cancel-searching").show();
            }else{
              setTimeout(function(){
                $INPUT_GROUPS.parents("p.fieldset").append('<i class="fa fa-times cancel-searching" aria-label="Cancel search" title="Cancel search" role="button"></i>');
              }, 15);
            }

          },
          close: function() {
            r = [];
            $( this ).removeClass("ui-corner-top").addClass("ui-corner-all");
            $INPUT_GROUPS_WRAPPER.find("i.fa-refresh.refresh-searching").remove();
            load_spinner = false;
          },
          change: function( event, ui ) {
            if(this.value == ""){
              r = [];
              $INPUT_GROUPS_WRAPPER.find("i.fa-times.cancel-searching").hide();
              $('input[name="searchGroups"]').autocomplete("close");
            }
          },
          response: function( event, ui ) {
          },
          create: function( event, ui ) {
            $INPUT_GROUPS_WRAPPER.find("ul.ui-autocomplete").addClass("ui-autocomplete-search-items ui-autocomplete-clp");
          },
          appendTo: '#groups-container div.list-item-header #campus-search-groups'
        }).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
          label = $(item.label);
          labelText = label.find("span.ui-search-item-name").text().replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)(" + $.ui.autocomplete.escapeRegex(this.term) + ")(?![^<>]*>)(?![^&;]+;)", "gi"), "<strong>$1</strong>");
          label.find("span.ui-search-item-name").html(labelText);
          item.label = label.prop('outerHTML');
          return $( "<li></li>" )
          .data( "ui-autocomplete-item", item )
          .append( item.label )
          .appendTo( ul );
        };

        /* ********** SEE PHOTOS ********** */

        $('div#group-feeds-preview-container').on("click", "div.feedpostImagesContainerHidden", function(){

          event.preventDefault();

          var $pswp = $('.pswp')[0];
           
          var $container = $(this).find('div.fp-hidden-img');

          var $index = $(this).index();
          var options = {
              index : $index,
              bgOpacity : 0.7,
              showHideOpacity : true,
              shareEl : false
          }

          var img_items = [];

          $.each($container.find("span"), function(index, img){
            img_items[index] = {
              'src' : $(img).attr("data-imageurl"),
              'w' : $(img).attr("data-width"),
              'h' : $(img).attr("data-height")
            };
          });
           
          // Initialize PhotoSwipe
          var PS = new PhotoSwipe($pswp, PhotoSwipeUI_Default, img_items, options);
          PS.init();

        });

        /* ********** FEED ********** */

        var last_elem_ctn = 0;

        /*
        $("#feed-post-button").click(function(e){

          $("#feed-postform").show().find("textarea").focus();

        });
        */

        var FEED = setInterval(function(e){

          var $LAST_FEED = $("#feed-container #feed-list li").eq(-1);

          $("#feed-container #feed-list").prepend($LAST_FEED).find("li:eq(0)").css("left", "-1000px").animate({"left" : "0px"}, 700, "easeOutBack");

        }, 5000);

      </script> 
  <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. --> 
  <script>
          (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
          function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
          e=o.createElement(i);r=o.getElementsByTagName(i)[0];
          e.src='//www.google-analytics.com/analytics.js';
          r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
          ga('create','UA-XXXXX-X');ga('send','pageview');
      </script>   
 </body>
</html>
